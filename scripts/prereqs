#! /usr/bin/env bash

set -eu -o pipefail

prereqs_found=true

function has() {
    local tool=$1
    local tool_install_direction=$2
    if [[ -n $(type -p "${tool}") ]]; then
        echo "${tool} installed."
    else
        echo "WARNING: ${tool} not found, install via: ${tool_install_direction}"
        prereqs_found=false
    fi
}

has go "brew install go"
has bash "brew install bash"
has yarn "brew install yarn"
has pre-commit "brew install pre-commit"
has shellcheck "brew install shellcheck"
has docker "Get Docker CE for Mac from https://download.docker.com/mac/stable/Docker.dmg"
has psql "brew install postgresql"
has go-bindata "brew install go-bindata"
has node "brew install node@10 && brew link --force node@10"
has pkcs11-tool "brew install opensc; chmod go+w /usr/local/bin/pkcs11-tool; brew link opensc"
has pkcs15-tool "brew install opensc; chmod go+w /usr/local/bin/pkcs15-tool; brew link opensc"

# macOS only
if [[ $(uname -s) = Darwin ]]; then
    has watchman "brew install watchman"
fi

# not on CircleCI
if [[ -z ${CIRCLECI-} ]]; then
    has direnv "brew install direnv"
    has aws-vault "brew cask install aws-vault"
    has entr "brew install entr"
    has circleci "brew install circleci"
fi


if [[ $prereqs_found == "true" ]]; then
    echo "OK: all prereqs found"
else
    echo "ERROR: some prereqs missing, please install them"
    exit 1
fi

# Now check versions are correct for prereqs
echo
check-hosts-file
check-bash-version
check-go-version
check-gopath
check-node-version
check-go-bindata-version
