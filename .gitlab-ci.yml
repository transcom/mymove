# You can override the included template(s) by including variable overrides
# SAST customization: https://docs.gitlab.com/ee/user/application_security/sast/#customizing-the-sast-settings
# Secret Detection customization: https://docs.gitlab.com/ee/user/application_security/secret_detection/pipeline/#customization
# Dependency Scanning customization: https://docs.gitlab.com/ee/user/application_security/dependency_scanning/#customizing-the-dependency-scanning-settings
# Container Scanning customization: https://docs.gitlab.com/ee/user/application_security/container_scanning/#customizing-the-container-scanning-settings
# Note that environment variables can be set in several places
# See https://docs.gitlab.com/ee/ci/variables/#cicd-variable-precedence
variables:
  #Docker config
  DOCKER_AUTH_CONFIG: "{\"auths\":{\"https://index.docker.io/v1/\":{\"auth\":\"$CI_REGISTRY_USER:$CI_REGISTRY_PASSWORD\"}}}"
  #hard code sha as newer version of debian is needed for pre-test
  DOCKER_APP_IMAGE: milmove01/transcom-docker:milmove-app-ubuntu
  DOCKER_BASE_IMAGE: milmove01/transcom-docker:base
  DOCKERHUB_USERNAME: DOCKERHUB_USERNAME
  DOCKERHUB_PASSWORD: DOCKERHUB_PASSWORD
  DOCKER_TOKEN: DOCKER_TOKEN
  CI_DEBUG_SERVICES: true
  registry: https://registry.hub.docker.com/

  #
  #Circle CI need to replace
  #CIRCLE_PROJECT_USERNAME: "my-username"  # Replace with the actual namespace
  CIRCLE_PROJECT_REPONAME: "mymove"      # Replace with your GitLab project name
  CIRCLE_JOB: "$CI_JOB_NAME"              # Map to GitLab's job name variable
  CIRCLE_BRANCH: "$CI_COMMIT_BRANCH"      # Map to GitLab's branch variable
  #CIRCLE_TOKEN: "$GITLAB_API_TOKEN"       # GitLab API token for querying pipelines
  CIRCLE_BUILD_NUM: "$CI_PIPELINE_ID"

  GOPATH: "/home/transcom/go"  #Go path on the app image
  GOLANGCI_LINT_CONCURRENCY: "4"
  GOLANGCI_LINT_VERBOSE: "-v"

  # Specify the environment: loadtest, demo, exp
  DP3_ENV: &dp3_env demo

  # Specify the branch to deploy TODO: this might be not needed. So far useless
  DP3_BRANCH: &dp3_branch B-22106-integration-attempt-9543

  # Ignore branches for integration tests
  INTEGRATION_IGNORE_BRANCH: &integration_ignore_branch B-22106-integration-attempt-9543
  INTEGRATION_MTLS_IGNORE_BRANCH: &integration_mtls_ignore_branch B-22106-integration-attempt-9543
  CLIENT_IGNORE_BRANCH: &client_ignore_branch B-22106-integration-attempt-9543
  SERVER_IGNORE_BRANCH: &server_ignore_branch B-22106-integration-attempt-9543

  OTEL_IMAGE_TAG: &otel_image_tag "git-$OTEL_VERSION-$CI_COMMIT_SHORT_SHA"

  CDPS_RUNNER_TAG: &cdps_runner_tag milmove
  EKS_CLUSTER_RUNNER_TAG: &eks_cluster_runner_tag eks_cluster_runner


  postgres: &postgres harbor.csde.caci.com/docker.io/library/postgres:16.4
  #postgres: &postgres postgres:16.4
  redis: &redis harbor.csde.caci.com/docker.io/library/redis:5.0.6

stages:
- pre_checks
- build
- test
- push
- deploy
- prod_approval
- push_prd
- deploy_prd

#anchors
#set safe directory and path
.setup_milmove_env: &setup_milmove_env
    - git config --global --add safe.directory /builds/milmove/mymove
    - export PATH=${PATH}:${GOPATH}/bin:~/transcom/mymove/builds/milmove/mymove:/builds/milmove/mymove/scripts:/builds/milmove/mymove/bin
    - export REACT_APP_ERROR_LOGGING=otel
    # - echo "Listing all environment variables:"
    # - printenv

.announce_failure: &announce_failure
  #- if [[ "$CI_COMMIT_BRANCH" == "main" && "$CI_JOB_STATUS" == "failed" ]]; then
  - echo $CI_COMMIT_BRANCH
  - echo $CI_JOB_STATUS
  - echo "Announcing broken branch in GitLab CI"
  # fi

.setup_tls_vars_dp3: &setup_tls_vars_dp3
  - |
    if [[ "$DP3_ENV" == "exp" || "$DP3_ENV" == "loadtest" || "$DP3_ENV" == "demo" ]]; then
      export ENV=$(echo ${DP3_ENV} | tr '[:lower:]' '[:upper:]');
      export TLS_CERT=$(eval echo \$${ENV}_DP3_CERT);
      export TLS_KEY=$(eval echo \$${ENV}_DP3_KEY);
      export TLS_CA=$(eval echo \$${ENV}_DP3_CA);
    fi

.setup_aws_vars_dp3: &setup_aws_vars_dp3
  - unset AWS_DEFAULT_REGION
  - unset AWS_ACCOUNT_ID
  - unset AWS_ACCESS_KEY_ID
  - unset AWS_SECRET_ACCESS_KEY
  - export SERVICE_RESERVATION_CPU=2048
  - export SERVICE_RESERVATION_MEM=4096
  - export SERVICE_RESERVATION_APP_MEM=4096
  - export SERVICE_RESERVATION_CLIENT_MEM=4096
  - |
    if [[ "$DP3_ENV" == "exp" || "$DP3_ENV" == "loadtest" || "$DP3_ENV" == "demo" ]]; then
      export ENV=$(echo ${DP3_ENV} | tr '[:lower:]' '[:upper:]');
      export AWS_DEFAULT_REGION=$(eval echo \$${ENV}_REGION);
      export AWS_ACCOUNT_ID=$(eval echo \$${ENV}_ACCOUNT_ID);
      export AWS_ACCESS_KEY_ID=$(eval echo \$${ENV}_ACCESS_KEY_ID);
      export AWS_SECRET_ACCESS_KEY=$(eval echo \$${ENV}_SECRET_ACCESS_KEY);
    fi

.setup_release_dp3: &setup_release_dp3
  - |
    if [[ "$DP3_ENV" == "exp" || "$DP3_ENV" == "loadtest" || "$DP3_ENV" == "demo" ]]; then
      export ENV=$(echo ${DP3_ENV} | tr '[:lower:]' '[:upper:]');
      export AWS_DEFAULT_REGION=$(eval echo \$${ENV}_REGION);
      export AWS_ACCOUNT_ID=$(eval echo \$${ENV}_ACCOUNT_ID);
      export ECR_REPOSITORY_URI=$(echo ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com)
      export APP_DOCKER_FILE=Dockerfile.dp3
      export TASK_DOCKER_FILE=Dockerfile.tasks_dp3
      export APP_ENVIRONMENT=$DP3_ENV
    fi


.setup_aws_vars_com_dev: &setup_aws_vars_com_dev
  - export AWS_REGION=$COM_REGION
  - export AWS_ACCOUNT_ID=$DEV_ACCOUNT_ID
  - export AWS_ACCESS_KEY_ID=$DEV_ACCESS_KEY_ID
  - export AWS_SECRET_ACCESS_KEY=$DEV_SECRET_KEY

.setup_aws_vars_stg: &setup_aws_vars_stg
  - unset AWS_DEFAULT_REGION
  - unset AWS_ACCOUNT_ID
  - unset AWS_ACCESS_KEY_ID
  - unset AWS_SECRET_ACCESS_KEY
  - export AWS_DEFAULT_REGION=$STG_REGION
  - export AWS_ACCOUNT_ID=$STG_ACCOUNT_ID
  - export AWS_ACCESS_KEY_ID=$STG_ACCESS_KEY_ID
  - export AWS_SECRET_ACCESS_KEY=$STG_SECRET_ACCESS_KEY
  - export SERVICE_RESERVATION_CPU=2048
  - export SERVICE_RESERVATION_MEM=4096
  - export SERVICE_RESERVATION_APP_MEM=4096
  - export SERVICE_RESERVATION_CLIENT_MEM=4096

.setup_tls_vars_stg: &setup_tls_vars_stg
  - export TLS_CERT=$STG_MOVE_MIL_DOD_TLS_CERT
  - export TLS_KEY=$STG_MOVE_MIL_DOD_TLS_KEY
  - export TLS_CA=$STG_MOVE_MIL_DOD_TLS_CA

.setup_aws_vars_prd: &setup_aws_vars_prd
  - unset AWS_DEFAULT_REGION
  - unset AWS_ACCOUNT_ID
  - unset AWS_ACCESS_KEY_ID
  - unset AWS_SECRET_ACCESS_KEY
  - export AWS_DEFAULT_REGION=$PRD_REGION
  - export AWS_ACCOUNT_ID=$PRD_ACCOUNT_ID
  - export AWS_ACCESS_KEY_ID=$PRD_ACCESS_KEY_ID
  - export AWS_SECRET_ACCESS_KEY=$PRD_SECRET_ACCESS_KEY
  - export SERVICE_RESERVATION_CPU=2048
  - export SERVICE_RESERVATION_MEM=4096
  - export SERVICE_RESERVATION_APP_MEM=16384
  - export SERVICE_RESERVATION_CLIENT_MEM=4096


.setup_tls_vars_prd: &setup_tls_vars_prd
  - export TLS_CERT=$PRD_MOVE_MIL_DOD_TLS_CERT
  - export TLS_KEY=$PRD_MOVE_MIL_DOD_TLS_KEY
  - export TLS_CA=$PRD_MOVE_MIL_DOD_TLS_CA

.setup_release_stg: &setup_release_stg
  #if main
  - export ECR_REPOSITORY_URI=${STG_ACCOUNT_ID}.dkr.ecr.${STG_REGION}.amazonaws.com
  - export APP_DOCKER_FILE=Dockerfile
  - export TASK_DOCKER_FILE=Dockerfile.tasks
  #TODO: update demo to stg
  - export APP_ENVIRONMENT=stg

.setup_release_prd: &setup_release_prd
  #build off prd variables
  - export ECR_REPOSITORY_URI=${PRD_ACCOUNT_ID}.dkr.ecr.${PRD_REGION}.amazonaws.com
  - export APP_DOCKER_FILE=Dockerfile
  - export TASK_DOCKER_FILE=Dockerfile.tasks
  #TODO: update exp to prod
  - export APP_ENVIRONMENT=prd

.kaniko_before_setup: &kaniko_before_setup
  # prep login for kaniko
  mkdir -p /kaniko/.docker
  echo "Simulating Docker image build setup..."
  echo "{\"credHelpers\":{\"${ECR_REPOSITORY_URI}\":\"ecr-login\"}}" > /kaniko/.docker/config.json

.check_dp3: &check_dp3
 - if: (($DP3_ENV == "exp" || $DP3_ENV == "loadtest" || $DP3_ENV == "demo") && $DP3_BRANCH == $CI_COMMIT_BRANCH)

.check_main: &check_main
  - if: '$CI_COMMIT_BRANCH == "main"'

.check_debug: &check_debug
  - if: '$debug == "true"'

.check_integration_ignore_branch: &check_integration_ignore_branch
  - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == $INTEGRATION_IGNORE_BRANCH'

.check_integration_mtls_ignore_branch: &check_integration_mtls_ignore_branch
  - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == $INTEGRATION_MTLS_IGNORE_BRANCH'

.check_client_ignore_branch: &check_client_ignore_branch
  - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == $CLIENT_IGNORE_BRANCH'

.check_server_ignore_branch: &check_server_ignore_branch
  - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == $SERVER_IGNORE_BRANCH'


.install_yarn: &install_yarn
  - |
    git config --global url."https://github".insteadOf ssh://git@github
    git config --global url."https://github.com/".insteadOf git@github.com:
    mkdir -p /builds/milmove/mymove/.cache
    mkdir -p /builds/milmove/mymove/.cache/yarn
    yarn install --frozen-lockfile --cache-folder /builds/milmove/mymove/.cache/yarn
    scripts/check-generated-code yarn.lock
    echo "yarn check dependencies"
    ./scripts/rebuild-dependencies-without-binaries

.yarn_cache: &yarn_cache
    key:
      files:
        - yarn.lock
    paths:
      - .cache/yarn
    policy: pull-push

.go_cache: &go_cache
    key:
      files:
        - go.sum
    paths:
      - $GOPATH/pkg/mod
      - /builds/milmove/mymove/bin
    policy: pull-push

.node_cache: &node_cache
  # most npm libraries will only have 1 entry for the base project deps
  key:
    files:
      - package-lock.json
  paths:
    - node_modules/
  policy: pull-push

.setup_generic_app_env_variables: &setup_generic_app_env_variables
  - |
      export APPLICATION=app
      export DB_PASSWORD=mysecretpassword
      export DB_USER_LOW_PRIV=crud
      export DB_PASSWORD_LOW_PRIV=mysecretpassword
      export DB_USER=postgres
      export DB_HOST=localhost
      export DB_PORT=5432
      export MIGRATION_MANIFEST='/builds/milmove/mymove/migrations/app/migrations_manifest.txt'
      export DML_MIGRATION_MANIFEST='/builds/milmove/mymove/migrations/app/dml_migrations_manifest.txt'
      export DDL_TYPES_MIGRATION_MANIFEST='/builds/milmove/mymove/migrations/app/ddl_types_manifest.txt'
      export DDL_TABLES_MIGRATION_MANIFEST='/builds/milmove/mymove/migrations/app/ddl_tables_manifest.txt'
      export DDL_VIEWS_MIGRATION_MANIFEST='/builds/milmove/mymove/migrations/app/ddl_views_manifest.txt'
      export DDL_FUNCTIONS_MIGRATION_MANIFEST='/builds/milmove/mymove/migrations/app/ddl_functions_manifest.txt'
      export MIGRATION_PATH='file:///builds/milmove/mymove/migrations/app/schema;file:///builds/milmove/mymove/migrations/app/secure'
      export DDL_TYPES_MIGRATION_PATH='file:///builds/milmove/mymove/migrations/app/ddl_migrations/ddl_types'
      export DDL_TABLES_MIGRATION_PATH='file:///builds/milmove/mymove/migrations/app/ddl_migrations/ddl_tables'
      export DDL_VIEWS_MIGRATION_PATH='file:///builds/milmove/mymove/migrations/app/ddl_migrations/ddl_views'
      export DDL_FUNCTIONS_MIGRATION_PATH='file:///builds/milmove/mymove/migrations/app/ddl_migrations/ddl_functions'
      export EIA_KEY=db2522a43820268a41a802a16ae9fd26

.setup_devseed_env_variables: &setup_devseed_env_variables
  - |
      export DB_NAME=dev_db
      export DB_NAME_DEV=dev_db
      export ENVIRONMENT=development
      export DOD_CA_PACKAGE=/builds/milmove/mymove/config/tls/milmove-cert-bundle.p7b

.setup_server_env_variables: &setup_server_env_variables
    - |
      echo "make server_test_build for app"
      export LOGIN_GOV_SECRET_KEY=$(echo $E2E_LOGIN_GOV_SECRET_KEY | base64 --decode)
      export OKTA_CUST_CLIENT_ID=notrealkey
      export OKTA_CUSTOMER_SECRET_KEY=notrealkey
      export OKTA_OFFICE_SECRET_KEY=notrealkey1
      export OKTA_ADMIN_SECRET_KEY=notrealkey2
      export OKTA_TENANT_ORG_URL=test-milmove.okta.mil
      export GOTEST_PARALLEL=8
      export DB_PORT_TEST=5433
      export DB_NAME=test_db
      export DB_NAME_TEST=test_db
      export DTOD_USE_MOCK='true'
      export ENV=test
      export ENVIRONMENT=test
      export SERVER_REPORT=1
      export COVERAGE=1
      export SERVE_API_INTERNAL='true'
      export OKTA_CUSTOMER_CLIENT_ID=1q2w3e4r5t6y7u8i9o
      export OKTA_ADMIN_CLIENT_ID=AQ1SW2DE3FR4G5
      export OKTA_OFFICE_CLIENT_ID=9f9f9s8s90gig9
      export OKTA_API_KEY=notrealapikey8675309
      export OKTA_OFFICE_GROUP_ID=notrealgroupId
      export OKTA_CUSTOMER_GROUP_ID=notrealcustomergroupId
      export IWS_RBS_HOST=pkict.dmdc.osd.mil

.setup_env_intergration_mtls: &setup_env_intergration_mtls
  - |
    echo "Setting up environment variables"
    export MIL_MOVE_DOD_CA_CERT=$(cat config/tls/devlocal-ca.pem)
    export MIL_MOVE_DOD_TLS_CERT=$(cat config/tls/devlocal-https.pem)
    export MIL_MOVE_DOD_TLS_KEY=$(cat config/tls/devlocal-https.key)
    export CLIENT_AUTH_SECRET_KEY=$(cat config/tls/devlocal-client_auth_secret.key)
    export LOGIN_GOV_SECRET_KEY=$(echo $E2E_LOGIN_GOV_SECRET_KEY | base64 --decode)
    export HERE_MAPS_APP_ID=$E2E_HERE_MAPS_APP_ID
    export HERE_MAPS_APP_CODE=$E2E_HERE_MAPS_APP_CODE
    # echo "Overriding application-specific configurations"
    # sed 's,^,export ,' config/env/review.app.env > server_env
    # source server_env
    export HERE_MAPS_GEOCODE_ENDPOINT=https://geocoder.api.here.com/6.2/geocode.json
    export HERE_MAPS_ROUTING_ENDPOINT=https://route.api.here.com/routing/7.2/calculateroute.json
    export LOGIN_GOV_CALLBACK_PORT=4000
    export LOGIN_GOV_CALLBACK_PROTOCOL=http
    make db_dev_create >> $CI_PROJECT_DIR/db_dev_create.txt

    bin/milmove migrate
    mkdir -p build
    touch build/index.html
    bin/milmove serve 2>&1 | tee server.log &

.e2e_tests_playwright: &e2e_tests_playwright
  - |
     echo "Preparing the environment"
     sed 's,^,export ,' config/env/review.app.env > server_env
     source server_env
     make db_dev_create

     echo "Installing Playwright dependencies"
     yarn install --frozen-lockfile --cache-folder ~/.cache/yarn
     ./node_modules/.bin/playwright install

sast:
  stage: pre_checks
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  interruptible: true
include:
- template: Jobs/SAST.gitlab-ci.yml
- template: Jobs/Dependency-Scanning.gitlab-ci.yml
- template: Jobs/Secret-Detection.gitlab-ci.yml

anti_virus:
  stage: pre_checks
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  image: milmove/clamav-ci # Custom image with ClamAV pre-installed
  script:
    - pwd
    - clamscan --version # Verify ClamAV installation
    - ls -la $CI_PROJECT_DIR/anti-virus # Debug to confirm whitelist files exist
    - cp -v $CI_PROJECT_DIR/anti-virus/whitelist-*.{fp,ign2} /var/lib/clamav/ # Update paths
    - echo "Running ClamAV scan..."
    - >
      clamscan \
        --recursive \
        --infected \
        --detect-pua=yes \
        --exclude-pua=NetTool \
        --exclude-pua=PWTool \
        --max-scansize=300M \
        --max-filesize=100M \
        --max-recursion=30 \
        --max-files=50000 \
        --tempdir=/tmp \
        $CI_PROJECT_DIR
  after_script:
    - *announce_failure
  rules:
    - *check_main

# Prep the public folder for frontend dependency serving
# This is needed for things like pdfjs-dist
prep_server_hosted_client_deps:
  stage: pre_checks
  interruptible: true
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  image: $DOCKER_APP_IMAGE
  before_script:
    - *setup_milmove_env
  script: |
    echo "Running prep_server_hosted_client_deps"
    ./scripts/fetch-react-file-viewer-from-yarn
  after_script:
    - *announce_failure
  artifacts:
    paths:
      - /builds/milmove/mymove/public

pre_deps_golang:
  stage: pre_checks
  interruptible: true
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  image: $DOCKER_APP_IMAGE
  before_script:
    - *setup_milmove_env
  variables:
    KUBERNETES_MEMORY_REQUEST: "4Gi"
    KUBERNETES_MEMORY_LIMIT: "4Gi"
  script:
    - for i in $(seq 1 5); do go mod download && break || s=$? && sleep 5; done; (exit $s)
    - scripts/check-generated-code go.sum
    - make bin/swagger
  after_script:
    - *announce_failure
  cache:
    - <<: *go_cache
  artifacts:
    paths:
      - /builds/milmove/mymove/bin/
      - /builds/milmove/mymove/swagger/
  #TODO: Optimization potential
  # cache:
  #   key: "$CI_COMMIT_REF_SLUG-go"
  #   paths:
  #     - $GOPATH/pkg/mod
  #     - /builds/milmove/mymove/bin  # Ensure this path is correct and writable.
  # Optionally, you can define an after_script for cleanup or notifications.
golang_lint:
  stage: pre_checks
  interruptible: true
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  image: harbor.csde.caci.com/docker.io/golangci/golangci-lint:$GOLANGCI_LINT_VERSION # Refer to https://hub.docker.com/r/golangci/golangci-lint
  script:
# Write the code coverage report to gl-code-quality-report.json
    # and print linting issues to stdout in the format: path/to/file:line description
    # remove `--issues-exit-code 0` or set to non-zero to fail the job if linting issues are detected
    - golangci-lint run --issues-exit-code 0 --print-issued-lines=false --timeout=25m --out-format code-climate:gl-code-quality-report.json,line-number
  artifacts:
      reports:
        codequality: gl-code-quality-report.json
      paths:
        - gl-code-quality-report.json
      when: always
  allow_failure: true

# WIP but failing and will need to get back to see if this is a viable option for go test coverage
# golang_coverage:
#   stage: pre_checks
#   interruptible: true
#   tags:
#     - $EKS_CLUSTER_RUNNER_TAG
#   image: $DOCKER_APP_IMAGE
#   services:
#     - name: $postgres
#     - name: $redis
#   before_script:
#     - *setup_milmove_env
#   variables:
#     KUBERNETES_CPU_REQUEST: "4"
#     KUBERNETES_MEMORY_REQUEST: "8Gi"
#     KUBERNETES_MEMORY_LIMIT: "8Gi"
#     APPLICATION: app
#     # 8 since this runs on xlarge with 8 CPUs
#     GOTEST_PARALLEL: 8
#     DB_PASSWORD: mysecretpassword
#     DB_USER_LOW_PRIV: crud
#     DB_PASSWORD_LOW_PRIV: mysecretpassword
#     DB_USER: postgres
#     DB_HOST: localhost
#     DB_PORT_TEST: 5432
#     DB_PORT: 5432
#     DB_NAME: test_db
#     DB_NAME_TEST: test_db
#     DTOD_USE_MOCK: 'true'
#     MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/migrations_manifest.txt'
#     MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/schema;file:///builds/milmove/mymove/migrations/app/secure'
#     EIA_KEY: db2522a43820268a41a802a16ae9fd26 # dummy key generated with openssl rand -hex 16
#     ENV: test
#     ENVIRONMENT: test
#     SERVER_REPORT: 1
#     COVERAGE: 1
#     SERVE_API_INTERNAL: 'true'
#     OKTA_CUSTOMER_CLIENT_ID: 1q2w3e4r5t6y7u8i9o
#     OKTA_ADMIN_CLIENT_ID: AQ1SW2DE3FR4G5
#     OKTA_OFFICE_CLIENT_ID: 9f9f9s8s90gig9
#     OKTA_API_KEY: notrealapikey8675309
#     OKTA_OFFICE_GROUP_ID: notrealgroupId
#     OKTA_CUSTOMER_GROUP_ID: notrealcustomergroupId
#     POSTGRES_DB: test_db #for postgres container
#     POSTGRES_USER: postgres
#     POSTGRES_PASSWORD: mysecretpassword
#     POSTGRES_HOST_AUTH_METHOD: trust
#     DPS_AUTH_SECRET_KEY: placeholder
#     CSRF_AUTH_KEY: d096fd8529eefaa46497849d11d2ff2e979ddfaed1aff058524ada9bceadd67c
#     IWS_RBS_ENABLED: 0
#     IWS_RBS_HOST: "pkict.dmdc.osd.mil"
#   script:
#     - go test ./... -coverprofile=coverage.txt -covermode count
#     - go get github.com/boumenot/gocover-cobertura
#     - go run github.com/boumenot/gocover-cobertura < coverage.txt > coverage.xml
#   allow_failure: true
#   after_script:
#     - *announce_failure
#   artifacts:
#     reports:
#       coverage_report:
#         coverage_format: cobertura
#         path: /builds/milmove/mymove/coverage.xml

pre_deps_yarn:
  stage: pre_checks
  interruptible: true
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  image: $DOCKER_APP_IMAGE
  before_script:
    - *setup_milmove_env
  script:
     - *install_yarn
  cache:
    - <<: *yarn_cache
  after_script:
      - *announce_failure

check_generated_code:
  stage: pre_checks
  image: $DOCKER_APP_IMAGE # Replace with the appropriate Docker image
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  needs:
   - pre_deps_golang
  before_script:
   - *setup_milmove_env
  script:
    - make server_generate mocks_generate
    - scripts/check-generated-code pkg/gen/ $(find . -type d -name "*mocks" -exec echo -n '{} ' \;)
  after_script:
    - *announce_failure
  rules:
    - *check_debug


check_tls_certificate_dp3:
  stage: pre_checks
  interruptible: true
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  image: $DOCKER_APP_IMAGE # Replace with your appropriate Docker image.
  before_script:
    - *setup_aws_vars_dp3
    - *setup_tls_vars_dp3
    - *announce_failure
  script:
    # Check if we are using a DP3 environment
    - echo "Checking if we are using a DP3 environment at all..."
    - |
      if [[ $DP3_ENV != "demo" && $DP3_ENV != "exp" && $DP3_ENV != "loadtest" ]]; then
        echo "Not a DP3 environment. Skipping TLS checks."
        exit 0
      fi
    - echo "Running TLS pair check..."
    - /usr/local/bin/check-tls-pair "${TLS_KEY}" "${TLS_CERT}"
  after_script:
    - *announce_failure
  rules:
    - *check_dp3

check_tls_certificate_stg:
  stage: pre_checks
  interruptible: true
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  image: $DOCKER_APP_IMAGE
  before_script:
    - *setup_aws_vars_stg
    - *setup_tls_vars_stg
  script:
    - echo "Running TLS pair check..."
    - /usr/local/bin/check-tls-pair "${TLS_KEY}" "${TLS_CERT}"
  after_script:
    - *announce_failure

check_tls_certificate_prd:
  stage: pre_checks
  interruptible: true
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  image: $DOCKER_APP_IMAGE
  before_script:
    - *setup_tls_vars_prd
    - *setup_aws_vars_prd
  script:
    - echo "Running TLS pair check for PRD environment..."
    - /usr/local/bin/check-tls-pair "${TLS_KEY}" "${TLS_CERT}"
  after_script:
    - *announce_failure

build_storybook:
  stage: build
  interruptible: true
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  image: $DOCKER_APP_IMAGE
  variables:
    KUBERNETES_CPU_REQUEST: "2"
    KUBERNETES_MEMORY_REQUEST: "10Gi"
    KUBERNETES_MEMORY_LIMIT: "10Gi"
  needs:
    - pre_deps_yarn
    - anti_virus
  cache:
    - <<: *yarn_cache
      policy: pull
  before_script:
    - *setup_milmove_env
    - *install_yarn
  script:
   - yarn build-storybook
  after_script:
    - *announce_failure
  artifacts:
    paths:
      - /builds/milmove/mymove/storybook-static
  rules:
    - *check_main

deploy_storybook_dp3:
  stage: deploy
  interruptible: true
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  image: $DOCKER_APP_IMAGE
  needs:
    - pre_deps_yarn
    - build_storybook
  before_script:
    - *setup_milmove_env
    - *setup_aws_vars_com_dev
  script:
    - echo "Deploying Storybook to S3..."
    - ./scripts/push-storybook-assets "storybook.dp3.us"
  after_script:
    - *announce_failure
  allow_failure: true
  artifacts:
    paths:
      - /builds/milmove/mymove/storybook-static
  rules:
  - *check_main

compile_app_client:
  stage: build
  interruptible: true
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  image: $DOCKER_APP_IMAGE
  cache:
    - <<: *yarn_cache
      policy: pull
  variables:
    KUBERNETES_CPU_REQUEST: "4"
    KUBERNETES_MEMORY_REQUEST: "12Gi"
    KUBERNETES_MEMORY_LIMIT: "12Gi"
  before_script:
  - *setup_milmove_env
  - *install_yarn
  needs:
    - pre_deps_yarn
  script:
     - make client_build
  artifacts:
    paths:
      - /builds/milmove/mymove/bin
      - /builds/milmove/mymove/build
      - playwright
      - playwright.config.js
      - package.json
      - eslint-plugin-ato
    expire_in: 1 week
  after_script:
    - *announce_failure


compile_app_server:
  stage: build
  interruptible: true
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  image: $DOCKER_APP_IMAGE
  cache:
    - <<: *go_cache
      policy: pull
    - <<: *yarn_cache
      policy: pull
  variables:
    KUBERNETES_CPU_REQUEST: "3"
    KUBERNETES_MEMORY_REQUEST: "10Gi"
    KUBERNETES_MEMORY_LIMIT: "10Gi"
  needs:
    - pre_deps_golang
    - pre_deps_yarn
  before_script:
    - *setup_milmove_env
    - *install_yarn
  script:
    - make -j 4 server_build build_tools
    - echo "Skipping server and tools compilation."
  artifacts:
    paths:
    - /builds/milmove/mymove/bin/milmove-tasks
    - /builds/milmove/mymove/bin/milmove
    - /builds/milmove/mymove/bin/rds-ca-rsa4096-g1.pem
    - /builds/milmove/mymove/bin/rds-ca-2019-root.pem
    - /builds/milmove/mymove/bin/tls-checker
    - /builds/milmove/mymove/bin/health-checker
    - /builds/milmove/mymove/bin/*
    - /builds/milmove/mymove/bin/ecs-deploy
    - /builds/milmove/mymove/config/tls/milmove-cert-bundle.p7b
    - /builds/milmove/mymove/config/tls/dod-sw-ca-66.pem
    - /builds/milmove/mymove/swagger/*
    - /builds/milmove/mymove/build
    - pkg/testdatagen/testdata
    - /builds/milmove/mymove/config/otel/*
    expire_in: 1 week
  after_script:
    - *announce_failure


#####################################
## Test stages various conditions  ##
#####################################
prep_integration_microservice:
  stage: test
  interruptible: true
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  image:
    name: gcr.io/kaniko-project/executor:v1.14.0-debug
    entrypoint: [""]
  needs:
    - pre_deps_yarn
    - compile_app_server
  before_script:
    - *kaniko_before_setup
  script:
    - export MOVE_MIL_DOD_CA_CERT=$(cat /builds/milmove/mymove/config/tls/devlocal-ca.pem)
    - export MOVE_MIL_DOD_TLS_CERT=$(cat config/tls/devlocal-https.pem)
    - export MOVE_MIL_DOD_TLS_KEY=$(cat config/tls/devlocal-https.key)
    - export CLIENT_AUTH_SECRET_KEY=$(cat config/tls/devlocal-client_auth_secret.key)
    # - export LOGIN_GOV_SECRET_KEY=$(echo $E2E_LOGIN_GOV_SECRET_KEY | base64 --decode)
    - export HERE_MAPS_APP_ID=$E2E_HERE_MAPS_APP_ID
    - export HERE_MAPS_APP_CODE=$E2E_HERE_MAPS_APP_CODE

    - echo "IWS_RBS_HOST is- $IWS_RBS_HOST"
    - echo "CSRF_AUTH_KEY is- $CSRF_AUTH_KEY"
    - echo "MOVE_MIL_DOD_CA_CERT is- $MOVE_MIL_DOD_CA_CERT"
    - echo "MOVE_MIL_DOD_TLS_CERT is- $MOVE_MIL_DOD_TLS_CERT"
    - echo "MOVE_MIL_DOD_TLS_KEY is- $MOVE_MIL_DOD_TLS_KEY"
    - echo "NO_TLS_ENABLED is- $NO_TLS_ENABLED"

    - /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --build-arg "MOVE_MIL_DOD_CA_CERT=${MOVE_MIL_DOD_CA_CER}"
      --build-arg "MOVE_MIL_DOD_TLS_CERT=${MOVE_MIL_DOD_TLS_CERT}"
      --build-arg "MOVE_MIL_DOD_TLS_KEY=${MOVE_MIL_DOD_TLS_KEY}"
      --build-arg "CLIENT_AUTH_SECRET_KEY=${CLIENT_AUTH_SECRET_KEY}"
      --build-arg "LOGIN_GOV_SECRET_KEY=${LOGIN_GOV_SECRET_KEY}"
      --build-arg "HERE_MAPS_APP_ID=${HERE_MAPS_APP_ID}"
      --build-arg "HERE_MAPS_APP_CODE=${HERE_MAPS_APP_CODE}"
      --dockerfile "${CI_PROJECT_DIR}/Dockerfile_gitlabtests_dp3"
      --destination "${CI_REGISTRY_IMAGE}:e2e-${CI_COMMIT_SHORT_SHA}"
  allow_failure: true
  after_script:
    - *announce_failure
  rules:
   - *check_integration_mtls_ignore_branch

pre_test:
  stage: test
  interruptible: true
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  image: $DOCKER_APP_IMAGE
  cache:
    - <<: *go_cache
      policy: pull
    - <<: *yarn_cache
      policy: pull
  needs:
    - pre_deps_golang
    - pre_deps_yarn
    - check_tls_certificate_stg
    - check_tls_certificate_prd
  variables:
    KUBERNETES_CPU_REQUEST: "2"
    KUBERNETES_MEMORY_REQUEST: "6Gi"
    KUBERNETES_MEMORY_LIMIT: "6Gi"
  before_script: *setup_milmove_env
  script:
    - export GODEBUG=asyncpreemptoff=1
    - echo "Save Baseline Spectral Lint"
    - |
      [ -d ~/transcom/mymove/spectral ] && cp -r ~/transcom/mymove/spectral /tmp/spectral_baseline || echo "Skipping saving baseline"
    - rm -rf ~/transcom/mymove/spectral
    - *install_yarn
    # this is so we can avoid go mod downloading and resulting in an error on a false positive
    - ./scripts/pre-commit-go-mod || exit 0
    - echo "Run pre-commit tests without golangci-lint, eslint, or prettier"
    - SKIP=golangci-lint,eslint,prettier pre-commit run --all-files
    - echo "Run pre-commit tests with golangci-lint only"
    - |
        export GOLANGCI_LINT_CONCURRENCY=4
        export GOLANGCI_LINT_VERBOSE=-v
        mkdir -p tmp/test-results/pretest
    # can this be removed in favor of golang_lint?
    - pre-commit run -v --all-files golangci-lint | tee tmp/test-results/pretest/golangci-lint.out
    - echo "Run prettier, eslint, danger checks"
    - yarn prettier-ci
    - yarn lint
    - yarn danger ci --failOnErrors
    - echo "Run spectral linter on all files"
    - ./scripts/ensure-spectral-lint /tmp/spectral_baseline spectral
  after_script:
    - *announce_failure
  artifacts:
      reports:
        codequality: tmp/test-results/pretest/golangci-lint.out
      paths:
        - tmp/test-results/pretest/golangci-lint.out #remove if golang_lint works
        - tmp/spectral_baseline/*.json #what do we need to store for review?
        - spectral/*.json #what do we need to store for review?
      when: always
  rules:
   - if: '$PRE_TEST_ALLOW_FAILURE == "true"'
     allow_failure: true
   - if: '$PRE_TEST_ALLOW_FAILURE == "false"'
     allow_failure: false
  #  - *check_server_ignore_branch  all branches for now

server_test:
  stage: test
  interruptible: true
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  image: $DOCKER_APP_IMAGE
  needs:
    - pre_deps_golang
  before_script:
  - *setup_milmove_env
  - *setup_generic_app_env_variables
  - *setup_server_env_variables
  services:
    - name: $postgres
    - name: $redis
  retry:
     max: 2
  variables:
    KUBERNETES_CPU_REQUEST: "3"
    KUBERNETES_MEMORY_REQUEST: "14Gi"
    KUBERNETES_MEMORY_LIMIT: "14Gi"
    APPLICATION: app
    # 8 since this runs on xlarge with 8 CPUs
    GOTEST_PARALLEL: 8
    DB_PASSWORD: mysecretpassword
    DB_USER_LOW_PRIV: crud
    DB_PASSWORD_LOW_PRIV: mysecretpassword
    DB_USER: postgres
    DB_HOST: localhost
    DB_PORT_TEST: 5432
    DB_PORT: 5432
    DB_NAME: test_db
    DB_NAME_TEST: test_db
    DTOD_USE_MOCK: 'true'
    MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/migrations_manifest.txt'
    DML_MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/dml_migrations_manifest.txt'
    DDL_TYPES_MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/ddl_types_manifest.txt'
    DDL_TABLES_MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/ddl_tables_manifest.txt'
    DDL_VIEWS_MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/ddl_views_manifest.txt'
    DDL_FUNCTIONS_MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/ddl_functions_manifest.txt'
    MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/schema;file:///builds/milmove/mymove/migrations/app/secure'
    DDL_TYPES_MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/ddl_migrations/ddl_types'
    DDL_TABLES_MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/ddl_migrations/ddl_tables'
    DDL_VIEWS_MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/ddl_migrations/ddl_views'
    DDL_FUNCTIONS_MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/ddl_migrations/ddl_functions'
    EIA_KEY: db2522a43820268a41a802a16ae9fd26 # dummy key generated with openssl rand -hex 16
    ENV: test
    ENVIRONMENT: test
    SERVER_REPORT: 1
    COVERAGE: 1
    SERVE_API_INTERNAL: 'true'
    OKTA_CUSTOMER_CLIENT_ID: 1q2w3e4r5t6y7u8i9o
    OKTA_ADMIN_CLIENT_ID: AQ1SW2DE3FR4G5
    OKTA_OFFICE_CLIENT_ID: 9f9f9s8s90gig9
    OKTA_API_KEY: notrealapikey8675309
    OKTA_OFFICE_GROUP_ID: notrealgroupId
    OKTA_CUSTOMER_GROUP_ID: notrealcustomergroupId
    POSTGRES_DB: test_db #for postgres container
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: mysecretpassword
    POSTGRES_HOST_AUTH_METHOD: trust
    DPS_AUTH_SECRET_KEY: placeholder
    CSRF_AUTH_KEY: d096fd8529eefaa46497849d11d2ff2e979ddfaed1aff058524ada9bceadd67c
    IWS_RBS_ENABLED: 0
    IWS_RBS_HOST: "pkict.dmdc.osd.mil"
  script:
    - for i in $(seq 1 5); do go mod download && break || s=$? && sleep 5; done; (exit $s)
    - scripts/check-generated-code go.sum
    - make bin/swagger
    - echo "server test -- build gotestsum and run scripts for report"
    - make -j 2 bin/milmove bin/gotestsum
    - make server_test
    - scripts/check-failed-test /builds/milmove/mymove/tmp/test-results/gotest/app/go-test-report.xml
  artifacts:
    paths:
      - /builds/milmove/mymove/bin/gotestsum
      - /builds/milmove/mymove/tmp/test-results
    when: always
    reports:
      junit: /builds/milmove/mymove/tmp/test-results/gotest/app/go-test-report.xml
  after_script:
    - *announce_failure
  rules:
   - if: '$SERVER_TEST_ALLOW_FAILURE == "true"'
     allow_failure: true
   - if: '$SERVER_TEST_ALLOW_FAILURE == "false"'
     allow_failure: false
  #  - *check_server_ignore_branch   # we want to make this run on every branch bc webhooks don't exist currently

server_test_coverage:
  stage: test
  interruptible: true
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  image: $DOCKER_APP_IMAGE
  needs:
    - pre_deps_golang
    - server_test
  before_script: *setup_milmove_env
  script:
    - echo "TODO understand recording stats and PR interaction"
    - echo "server test coverage"
    - |
        echo "Ensure Test Coverage Increasing"
        ./scripts/ensure-go-test-coverage \
        tmp/baseline-go-coverage/go-coverage.txt \
        tmp/test-results/gotest/app/go-coverage.txt
  after_script:
    - *announce_failure
  rules:
   - if: '$SERVER_TEST_ALLOW_FAILURE == "true"'
     allow_failure: true
   - if: '$SERVER_TEST_ALLOW_FAILURE == "false"'
     allow_failure: true #allow failure for now
   - *check_server_ignore_branch
  ###may need to rethink the logic and intent of this they save per the following and do some PR interaction
  # only save the cache on default branch builds because we only want to
  # change the baseline of test results on main builds
  #
  # Save the new baseline regardless of if the coverage succeeds
  # or fails as a merge to main means we have a new baseline. We
  # will use other means to measure if our coverage is increasing

client_test:
  stage: test
  interruptible: true
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  image: $DOCKER_APP_IMAGE
  variables:
    KUBERNETES_CPU_REQUEST: "4"
    KUBERNETES_MEMORY_REQUEST: "14Gi"
    KUBERNETES_MEMORY_LIMIT: "14Gi"
  needs:
    - pre_deps_yarn
  cache:
    - <<: *yarn_cache
      policy: pull
  before_script:
    - *setup_milmove_env
    - *install_yarn
  coverage: /All files[^|]*\|[^|]*\s+([\d\.]+)/
  dependencies:
    - pre_deps_yarn
  retry:
     max: 2
  script:
    - echo "client test coverage" | tee -a $CI_PROJECT_DIR/coverage.output
    - JEST_JUNIT_OUTPUT_DIR=jest-junit-reports yarn test:coverage -results=false >> $CI_PROJECT_DIR/coverage.output 2>&1
  artifacts:
    when: always
    reports:
      junit:
        - jest-junit-reports/junit.xml
    paths:
      - /builds/milmove/mymove/coverage
      - /builds/milmove/mymove/jest-junit-reports
      - $CI_PROJECT_DIR/coverage.output
  after_script:
    - *announce_failure
  rules:
   - if: '$CLIENT_TEST_ALLOW_FAILURE == "true"'
     allow_failure: true
   - if: '$CLIENT_TEST_ALLOW_FAILURE == "false"'
     allow_failure: false
  #  - *check_client_ignore_branch   # we want to make this run on every branch bc webhooks don't exist currently

client_test_coverage:
  stage: test
  interruptible: true
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  image: $DOCKER_APP_IMAGE
  needs:
    - pre_deps_yarn
    - client_test
  before_script: *setup_milmove_env
  # TODO: need to add cache for max coverage increase similar to this
  # https://stackoverflow.com/questions/54542922/force-coverage-increase-in-gitlab-prs
  script:
    - echo "TODO understand recording stats and PR interaction"
    - |
     echo "Ensure Test Coverage Increasing"
      ./scripts/ensure-js-test-coverage \
      tmp/baseline-jest-coverage/clover.xml \
      coverage/clover.xml
  after_script:
    - *announce_failure
  rules:
   - if: '$CLIENT_TEST_ALLOW_FAILURE == "true"'
     allow_failure: true
   - if: '$CLIENT_TEST_ALLOW_FAILURE == "false"'
     allow_failure: true #allow failure for now
   - *check_client_ignore_branch

integration_test_devseed:
  stage: test
  interruptible: true
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  image: $DOCKER_APP_IMAGE
  services:
    - name: $postgres
    - name: $redis
  variables:
    KUBERNETES_CPU_REQUEST: "2"
    KUBERNETES_MEMORY_REQUEST: "12Gi"
    KUBERNETES_MEMORY_LIMIT: "12Gi"
    APPLICATION: app
    DB_PASSWORD: mysecretpassword
    DB_USER_LOW_PRIV: crud
    DB_PASSWORD_LOW_PRIV: mysecretpassword
    DB_USER: postgres
    DB_HOST: localhost
    DB_PORT: 5432
    DB_NAME: dev_db
    DB_NAME_DEV: dev_db
    MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/migrations_manifest.txt'
    DML_MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/dml_migrations_manifest.txt'
    DDL_TYPES_MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/ddl_types_manifest.txt'
    DDL_TABLES_MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/ddl_tables_manifest.txt'
    DDL_VIEWS_MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/ddl_views_manifest.txt'
    DDL_FUNCTIONS_MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/ddl_functions_manifest.txt'
    MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/schema;file:///builds/milmove/mymove/migrations/app/secure'
    DDL_TYPES_MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/ddl_migrations/ddl_types'
    DDL_TABLES_MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/ddl_migrations/ddl_tables'
    DDL_VIEWS_MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/ddl_migrations/ddl_views'
    DDL_FUNCTIONS_MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/ddl_migrations/ddl_functions'
    EIA_KEY: db2522a43820268a41a802a16ae9fd26 # dummy key generated with openssl rand -hex 16
    ENVIRONMENT: development
    DOD_CA_PACKAGE: /builds/milmove/mymove/config/tls/milmove-cert-bundle.p7b
    POSTGRES_PASSWORD: mysecretpassword
    POSTGRES_DB: test_db
  needs:
    - pre_deps_golang
    - prep_server_hosted_client_deps
  before_script:
   - *setup_milmove_env
   - *setup_generic_app_env_variables
   - *setup_devseed_env_variables
  script:
    - echo "integration_test_devseed"
    - |
     export MOVE_MIL_DOD_CA_CERT=$(cat config/tls/devlocal-ca.pem)
     export MOVE_MIL_DOD_TLS_CERT=$(cat config/tls/devlocal-https.pem)
     export MOVE_MIL_DOD_TLS_KEY=$(cat config/tls/devlocal-https.key)
    - make db_dev_fresh
  after_script:
    - *announce_failure
  rules:
   - if: '$INTEGRATION_TEST_ALLOW_FAILURE == "true"'
     allow_failure: true
   - if: '$INTEGRATION_TEST_ALLOW_FAILURE == "false"'
     allow_failure: false
   - *check_integration_ignore_branch

integration_tests:
  stage: test
  interruptible: true
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  image: $DOCKER_APP_IMAGE
  needs:
    - pre_deps_yarn
    - pre_deps_golang
    - compile_app_client
    - compile_app_server
    - integration_test_my
    - integration_test_office
    - integration_test_admin
    - integration_test_devseed
  before_script: *setup_milmove_env
  script:
    - echo "TODO Add steps"
    - echo "integration_tests"
  after_script:
    - *announce_failure
  rules:
   - if: '$INTEGRATION_TEST_ALLOW_FAILURE == "true"'
     allow_failure: true
   - if: '$INTEGRATION_TEST_ALLOW_FAILURE == "false"'
     allow_failure: true # allow failure for now
   - *check_integration_ignore_branch


integration_test_mtls:
  stage: test
  interruptible: true
  cache:
    - <<: *yarn_cache
    - <<: *node_cache
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  image: registry.csde.caci.com/milmove/mymove:e2e-${CI_COMMIT_SHORT_SHA}
  services:
    - name: $postgres
    - name: $redis
    - name: registry.csde.caci.com/milmove/mymove:e2e-${CI_COMMIT_SHORT_SHA}
      alias: milmovelocal,officelocal,adminlocal,primelocal
      entrypoint: ["/bin/milmove"]
      command: ["serve"]
  needs:
    - prep_integration_microservice
  variables:
    KUBERNETES_SERVICE_CPU_REQUEST: "2"
    KUBERNETES_SERVICE_MEMORY_REQUEST: "4Gi"
    KUBERNETES_SERVICE_MEMORY_LIMIT: "4Gi"
    KUBERNETES_SERVICE_EPHEMERAL_STORAGE_REQUEST: "2Gi"
    CI_DEBUG_SERVICES: "true"
    CI_DEBUG_TRACE: "true"
    KUBERNETES_CPU_REQUEST: "2"
    KUBERNETES_MEMORY_REQUEST: "12Gi"
    KUBERNETES_MEMORY_LIMIT: "12Gi"
    FF_NETWORK_PER_BUILD: "true"
    PLAYWRIGHT_MY_URL: http://milmovelocal:4000
    PLAYWRIGHT_ADMIN_URL: http://adminlocal:4000
    PLAYWRIGHT_OFFICE_URL: http://officelocal:4000
    # partially taken from https://playwright.dev/docs/ci#sharding-in-circleci
    FEATURE_FLAG_MULTI_MOVE: 'true'
    FEATURE_FLAG_PPM: 'true'
    FEATURE_FLAG_NTS: 'true'
    FEATURE_FLAG_NTSR: 'true'
    FEATURE_FLAG_BOAT: 'true'
    FEATURE_FLAG_MOBILE_HOME: 'true'
    FEATURE_FLAG_CAC_VALIDATED_LOGIN: 'false'
    FEATURE_FLAG_VALIDATION_CODE_REQUIRED: 'false'
    FEATURE_FLAG_MOVE_LOCK: 'false'
    FEATURE_FLAG_OKTA_DODID_INPUT: 'false'
    FEATURE_FLAG_HEADQUARTERS_ROLE: 'true'
    FEATURE_FLAG_GSR_ROLE: 'false'
    FEATURE_FLAG_SAFETY_MOVE: 'false'
    FEATURE_FLAG_MANAGE_SUPPORTING_DOCS: 'false'
    FEATURE_FLAG_THIRD_ADDRESS_AVAILABLE: 'false'
    FEATURE_FLAG_QUEUE_MANAGEMENT: 'false'
    FEATURE_FLAG_UNACCOMPANIED_BAGGAGE: 'false'
    FEATURE_FLAG_ENABLE_ALASKA: 'false'
    FEATURE_FLAG_BULK_ASSIGNMENT: 'false'

    APPLICATION: app
    DB_PASSWORD: mysecretpassword
    DB_USER_LOW_PRIV: crud
    DB_PASSWORD_LOW_PRIV: mysecretpassword
    CI_REGISTRY: $CI_REGISTRY
    CI_REGISTRY_PASSWORD: $CI_REGISTRY_PASSWORD
    CI_REGISTRY_USER: $CI_REGISTRY_USER
    DB_USER: postgres
    DB_HOST: localhost
    DB_PORT: 5432
    DB_NAME: dev_db
    DB_NAME_DEV: dev_db
    MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/migrations_manifest.txt'
    DML_MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/dml_migrations_manifest.txt'
    DDL_TYPES_MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/ddl_types_manifest.txt'
    DDL_TABLES_MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/ddl_tables_manifest.txt'
    DDL_VIEWS_MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/ddl_views_manifest.txt'
    DDL_FUNCTIONS_MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/ddl_functions_manifest.txt'
    MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/schema;file:///builds/milmove/mymove/migrations/app/secure'
    DDL_TYPES_MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/ddl_migrations/ddl_types'
    DDL_TABLES_MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/ddl_migrations/ddl_tables'
    DDL_VIEWS_MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/ddl_migrations/ddl_views'
    DDL_FUNCTIONS_MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/ddl_migrations/ddl_functions'
    EIA_KEY: db2522a43820268a41a802a16ae9fd26 # dummy key generated with openssl rand -hex 16
    ENVIRONMENT: development
    DOD_CA_PACKAGE: /builds/milmove/mymove/config/tls/milmove-cert-bundle.p7b
    POSTGRES_PASSWORD: mysecretpassword
    POSTGRES_DB: test_db

    HERE_MAPS_GEOCODE_ENDPOINT: 'https: //geocoder.api.here.com/6.2/geocode.json'
    HERE_MAPS_ROUTING_ENDPOINT: 'https: //route.api.here.com/routing/7.2/calculateroute.json'
    LOGIN_GOV_CALLBACK_PORT: 4000
    LOGIN_GOV_CALLBACK_PROTOCOL: http
    OKTA_CUSTOMER_CLIENT_ID: 1q2w3e4r5t6y7u8i9o
    OKTA_ADMIN_CLIENT_ID: AQ1SW2DE3FR4G5
    OKTA_OFFICE_CLIENT_ID: 9f9f9s8s90gig9
    OKTA_CUSTOMER_SECRET_KEY: notrealkey
    OKTA_OFFICE_SECRET_KEY: notrealkey1
    OKTA_ADMIN_SECRET_KEY: notrealkey2
    OKTA_TENANT_CALLBACK_PORT: 4000
    OKTA_TENANT_CALLBACK_PROTOCOL: http
    OKTA_TENANT_ORG_URL: test-milmove.okta.mil
    OKTA_API_KEY: notrealapikey
    OKTA_OFFICE_GROUP_ID: notrealgroupId
    OKTA_CUSTOMER_GROUP_ID: notrealcustomergroupId
    CSRF_AUTH_KEY: d096fd8529eefaa46497849d11d2ff2e979ddfaed1aff058524ada9bceadd67c

    SERVE_API_SUPPORT: true
    SERVE_PRIME_SIMULATOR: true
    DEVLOCAL_CA: '/builds/milmove/mymove/config/tls/devlocal-ca.pem'


    HTTP_ADMIN_SERVER_NAME: adminlocal
    HTTP_MY_SERVER_NAME: milmovelocal
    HTTP_OFFICE_SERVER_NAME: officelocal
    HTTP_ORDERS_SERVER_NAME: orderslocal
    HTTP_PRIME_SERVER_NAME: primelocal

    MUTUAL_TLS_ENABLED: true
    MUTUAL_TLS_PORT: 9443
    SERVE_API_PRIME: true

    DB_DEBUG: false

    NO_TLS_ENABLED: true
    SERVE_ADMIN: 1
    IWS_RBS_HOST: 'pkict.dmdc.osd.mil'
    DTOD_USE_MOCK: true
  before_script:
    - *setup_milmove_env
    # - *setup_env_intergration_mtls
    # - export MOVE_MIL_DOD_CA_CERT=$(cat /builds/milmove/mymove/config/tls/devlocal-ca.pem)
    # - export MOVE_MIL_DOD_TLS_CERT=$(cat config/tls/devlocal-https.pem)
    # - export MOVE_MIL_DOD_TLS_KEY=$(cat config/tls/devlocal-https.key)
    # - export CLIENT_AUTH_SECRET_KEY=$(cat config/tls/devlocal-client_auth_secret.key)
    # - export LOGIN_GOV_SECRET_KEY=$(echo $E2E_LOGIN_GOV_SECRET_KEY | base64 --decode)
    # - export HERE_MAPS_APP_ID=$E2E_HERE_MAPS_APP_ID
    # - export HERE_MAPS_APP_CODE=$E2E_HERE_MAPS_APP_CODE
    # - export HERE_MAPS_GEOCODE_ENDPOINT=https://geocoder.api.here.com/6.2/geocode.json
    # - export HERE_MAPS_ROUTING_ENDPOINT=https://route.api.here.com/routing/7.2/calculateroute.json
    # - export LOGIN_GOV_CALLBACK_PORT=4000
    # - export LOGIN_GOV_CALLBACK_PROTOCOL=http
  script:
    # - echo "TODO Add steps"
    # - echo "integration_test_mtls"
    # - echo "Waiting for server to start"
    # - dockerize -wait http://milmovelocal:4000 -timeout 5m
    # - sed 's,^,export ,' /builds/milmove/mymove/config/env/review.app.env > server_env
    # - source server_env
    # - until $(curl --output /dev/null --silent --head --fail http://milmovelocal:4000); do printf '.'; sleep 1; done
    - curl http://milmovelocal:4000
    - pwd
    # - git config --global --add safe.directory /builds/milmove/mymove
    # - make bin/milmove
    - echo "IWS_RBS_HOST is- $IWS_RBS_HOST"
    - echo "CSRF_AUTH_KEY is- $CSRF_AUTH_KEY"
    - echo "MOVE_MIL_DOD_CA_CERT is- $MOVE_MIL_DOD_CA_CERT"
    - echo "MOVE_MIL_DOD_TLS_CERT is- $MOVE_MIL_DOD_TLS_CERT"
    - echo "MOVE_MIL_DOD_TLS_KEY is- $MOVE_MIL_DOD_TLS_KEY"
    - echo "NO_TLS_ENABLED is- $NO_TLS_ENABLED"

    - make db_dev_create
    - /bin/milmove migrate
            # mtls tests do not need client
    - mkdir -p build
    - touch build/index.html
    # - /bin/milmove serve 2>&1 | fmt
    - ./scripts/run-e2e-mtls-test
    # - curl http://milmovelocal:4000
    # - bin/milmove migrate >> $CI_PROJECT_DIR/milmove_migrate.output 2>&1
    # - make bin/prime-api-client
    # - echo "Running E2E mTLS tests"
    # - ./scripts/run-e2e-mtls-test >> $CI_PROJECT_DIR/e2e_mtls_test.output 2>&1
  artifacts:
    paths:
      - test-results/
      - $CI_PROJECT_DIR/e2e_mtls_test.output
      - $CI_PROJECT_DIR/milmove_migrate.output
    when: always
  after_script:
    - *announce_failure
  rules:
   - if: '$INTEGRATION_TEST_ALLOW_FAILURE == "true"'
     allow_failure: true
   - if: '$INTEGRATION_TEST_ALLOW_FAILURE == "false"'
     allow_failure: true # allow failure for now
   - *check_integration_mtls_ignore_branch

integration_test_admin:
  stage: test
  interruptible: true
  cache:
    - <<: *yarn_cache
    - <<: *node_cache
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  image: $DOCKER_APP_IMAGE
  services:
    - name: $postgres
    - name: $redis
    - name: registry.csde.caci.com/milmove/mymove:e2e-${CI_COMMIT_SHORT_SHA}
      alias: milmovelocal,officelocal,adminlocal,primelocal
      entrypoint: ["/bin/milmove"]
      command: ["serve"]
  variables:
    KUBERNETES_SERVICE_CPU_REQUEST: "2"
    KUBERNETES_SERVICE_MEMORY_REQUEST: "4Gi"
    KUBERNETES_SERVICE_MEMORY_LIMIT: "4Gi"
    KUBERNETES_SERVICE_EPHEMERAL_STORAGE_REQUEST: "2Gi"
    CI_DEBUG_SERVICES: "true"
    CI_DEBUG_TRACE: "true"
    KUBERNETES_CPU_REQUEST: "2"
    KUBERNETES_MEMORY_REQUEST: "12Gi"
    KUBERNETES_MEMORY_LIMIT: "12Gi"
    FF_NETWORK_PER_BUILD: "true"
    PLAYWRIGHT_MY_URL: http://milmovelocal:4000
    PLAYWRIGHT_ADMIN_URL: http://adminlocal:4000
    PLAYWRIGHT_OFFICE_URL: http://officelocal:4000
    APPLICATION: app
    DB_PASSWORD: mysecretpassword
    DB_USER_LOW_PRIV: crud
    DB_PASSWORD_LOW_PRIV: mysecretpassword
    DB_USER: postgres
    DB_HOST: localhost
    DB_PORT: 5432
    DB_NAME: dev_db
    DB_NAME_DEV: dev_db
    MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/migrations_manifest.txt'
    DML_MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/dml_migrations_manifest.txt'
    DDL_TYPES_MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/ddl_types_manifest.txt'
    DDL_TABLES_MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/ddl_tables_manifest.txt'
    DDL_VIEWS_MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/ddl_views_manifest.txt'
    DDL_FUNCTIONS_MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/ddl_functions_manifest.txt'
    MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/schema;file:///builds/milmove/mymove/migrations/app/secure'
    DDL_TYPES_MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/ddl_migrations/ddl_types'
    DDL_TABLES_MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/ddl_migrations/ddl_tables'
    DDL_VIEWS_MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/ddl_migrations/ddl_views'
    DDL_FUNCTIONS_MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/ddl_migrations/ddl_functions'
    EIA_KEY: db2522a43820268a41a802a16ae9fd26 # dummy key generated with openssl rand -hex 16
    ENVIRONMENT: development
    DOD_CA_PACKAGE: /builds/milmove/mymove/config/tls/milmove-cert-bundle.p7b
    POSTGRES_PASSWORD: mysecretpassword
    POSTGRES_DB: test_db

    IWS_RBS_HOST: 'pkict.dmdc.osd.mil'
    DTOD_USE_MOCK: 'true'
  needs:
    - prep_integration_microservice
  before_script:
      - *setup_milmove_env
      - *e2e_tests_playwright
  script:
    - echo $MIL_MOVE_DOD_CA_CERT
    - echo "TODO Add steps"
    - echo "integration_test_admin"
    - echo "Running integration tests for Admin"
    - ./node_modules/.bin/playwright test playwright/tests/admin \
        --reporter=html,junit \
        --trace=on \
        --shard="${CI_NODE_INDEX}/${CI_NODE_TOTAL}" \
        --workers=1 >> $CI_PROJECT_DIR/playwright_test_admin.output 2>&1
  artifacts:
    paths:
      - playwright-report/
      - complete-playwright-report.zip
      - playwright-results.xml
      - $CI_PROJECT_DIR/playwright_test_admin.output
    when: always
  # parallel: 6
  after_script:
    - *announce_failure
  rules:
   - if: '$INTEGRATION_TEST_ALLOW_FAILURE == "true"'
     allow_failure: true
   - if: '$INTEGRATION_TEST_ALLOW_FAILURE == "false"'
     allow_failure: true # allow failure for now
   - *check_integration_ignore_branch

integration_test_my:
  stage: test
  interruptible: true
  cache:
    - <<: *yarn_cache
    - <<: *node_cache
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  image: $DOCKER_APP_IMAGE
  services:
    - name: $postgres
    - name: $redis
    - name: registry.csde.caci.com/milmove/mymove:e2e-${CI_COMMIT_SHORT_SHA}
      alias: milmovelocal,officelocal,adminlocal,primelocal
      entrypoint: ["/bin/milmove"]
      command: ["serve"]
  variables:
    KUBERNETES_SERVICE_CPU_REQUEST: "2"
    KUBERNETES_SERVICE_MEMORY_REQUEST: "4Gi"
    KUBERNETES_SERVICE_MEMORY_LIMIT: "4Gi"
    KUBERNETES_SERVICE_EPHEMERAL_STORAGE_REQUEST: "2Gi"
    CI_DEBUG_SERVICES: "true"
    CI_DEBUG_TRACE: "true"
    FF_NETWORK_PER_BUILD: "true"
    KUBERNETES_CPU_REQUEST: "2"
    KUBERNETES_MEMORY_REQUEST: "12Gi"
    KUBERNETES_MEMORY_LIMIT: "12Gi"
    MIL_MOVE_DOD_CA_CERT: $(cat /builds/milmove/mymove/config/tls/devlocal-ca.pem)
    MIL_MOVE_DOD_TLS_CERT: $(cat /builds/milmove/mymove/config/tls/devlocal-https.pem)
    MIL_MOVE_DOD_TLS_KEY: $(cat /builds/milmove/mymove/config/tls/devlocal-https.key)
    CLIENT_AUTH_SECRET_KEY: $(cat /builds/milmove/mymove/config/tls/devlocal-client_auth_secret.key)
    LOGIN_GOV_SECRET_KEY: $(echo $E2E_LOGIN_GOV_SECRET_KEY | base64 --decode)
    HERE_MAPS_APP_ID: $E2E_HERE_MAPS_APP_ID
    HERE_MAPS_APP_CODE: $E2E_HERE_MAPS_APP_CODE

    PLAYWRIGHT_MY_URL: http://milmovelocal:4000
    PLAYWRIGHT_ADMIN_URL: http://adminlocal:4000
    PLAYWRIGHT_OFFICE_URL: http://officelocal:4000
    APPLICATION: app
    DB_PASSWORD: mysecretpassword
    DB_USER_LOW_PRIV: crud
    DB_PASSWORD_LOW_PRIV: mysecretpassword
    DB_USER: postgres
    DB_HOST: localhost
    DB_PORT: 5432
    DB_NAME: dev_db
    DB_NAME_DEV: dev_db
    MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/migrations_manifest.txt'
    DML_MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/dml_migrations_manifest.txt'
    DDL_TYPES_MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/ddl_types_manifest.txt'
    DDL_TABLES_MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/ddl_tables_manifest.txt'
    DDL_VIEWS_MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/ddl_views_manifest.txt'
    DDL_FUNCTIONS_MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/ddl_functions_manifest.txt'
    MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/schema;file:///builds/milmove/mymove/migrations/app/secure'
    DDL_TYPES_MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/ddl_migrations/ddl_types'
    DDL_TABLES_MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/ddl_migrations/ddl_tables'
    DDL_VIEWS_MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/ddl_migrations/ddl_views'
    DDL_FUNCTIONS_MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/ddl_migrations/ddl_functions'
    EIA_KEY: db2522a43820268a41a802a16ae9fd26 # dummy key generated with openssl rand -hex 16
    ENVIRONMENT: development
    DOD_CA_PACKAGE: /builds/milmove/mymove/config/tls/milmove-cert-bundle.p7b
    POSTGRES_PASSWORD: mysecretpassword
    POSTGRES_DB: test_db

    IWS_RBS_HOST: 'pkict.dmdc.osd.mil'
    DTOD_USE_MOCK: 'true'
  needs:
    - prep_integration_microservice
  before_script:
      - *setup_milmove_env
      - *e2e_tests_playwright
  script:
    - echo "TODO Add steps"
    - echo "integration_test_my"
    - echo "Running integration tests for My"
    - ./node_modules/.bin/playwright test playwright/tests/my \
        --reporter=html,junit \
        --trace=on \
        --shard="${CI_NODE_INDEX}/${CI_NODE_TOTAL}" \
        --workers=1 >> $CI_PROJECT_DIR/playwright_test_my.output 2>&1
  artifacts:
    paths:
      - playwright-report/
      - complete-playwright-report.zip
      - playwright-results.
      - $CI_PROJECT_DIR/playwright_test_my.output
    when: always
  after_script:
    - *announce_failure
  rules:
   - if: '$INTEGRATION_TEST_ALLOW_FAILURE == "true"'
     allow_failure: true
   - if: '$INTEGRATION_TEST_ALLOW_FAILURE == "false"'
     allow_failure: true # allow failure for now
   - *check_integration_ignore_branch

integration_test_office:
  stage: test
  interruptible: true
  cache:
    - <<: *yarn_cache
    - <<: *node_cache
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  image: $DOCKER_APP_IMAGE
  services:
    - name: $postgres
    - name: $redis
    - name: registry.csde.caci.com/milmove/mymove:e2e-${CI_COMMIT_SHORT_SHA}
      alias: milmovelocal,officelocal,adminlocal,primelocal
      entrypoint: ["/bin/milmove"]
      command: ["serve"]
  variables:
    KUBERNETES_SERVICE_CPU_REQUEST: "2"
    KUBERNETES_SERVICE_MEMORY_REQUEST: "4Gi"
    KUBERNETES_SERVICE_MEMORY_LIMIT: "4Gi"
    KUBERNETES_SERVICE_EPHEMERAL_STORAGE_REQUEST: "2Gi"
    CI_DEBUG_SERVICES: "true"
    CI_DEBUG_TRACE: "true"
    FF_NETWORK_PER_BUILD: "true"
    KUBERNETES_CPU_REQUEST: "2"
    KUBERNETES_MEMORY_REQUEST: "12Gi"
    KUBERNETES_MEMORY_LIMIT: "12Gi"
    MIL_MOVE_DOD_CA_CERT: $(cat /builds/milmove/mymove/config/tls/devlocal-ca.pem)
    MIL_MOVE_DOD_TLS_CERT: $(cat /builds/milmove/mymove/config/tls/devlocal-https.pem)
    MIL_MOVE_DOD_TLS_KEY: $(cat /builds/milmove/mymove//tls/devlocal-https.key)
    CLIENT_AUTH_SECRET_KEY: $(cat /builds/milmove/mymove/config/tls/devlocal-client_auth_secret.key)
    LOGIN_GOV_SECRET_KEY: $(echo $E2E_LOGIN_GOV_SECRET_KEY | base64 --decode)
    HERE_MAPS_APP_ID: $E2E_HERE_MAPS_APP_ID
    HERE_MAPS_APP_CODE: $E2E_HERE_MAPS_APP_CODE

    PLAYWRIGHT_MY_URL: http://milmovelocal:4000
    PLAYWRIGHT_ADMIN_URL: http://adminlocal:4000
    PLAYWRIGHT_OFFICE_URL: http://officelocal:4000
    APPLICATION: app
    DB_PASSWORD: mysecretpassword
    DB_USER_LOW_PRIV: crud
    DB_PASSWORD_LOW_PRIV: mysecretpassword
    DB_USER: postgres
    DB_HOST: localhost
    DB_PORT: 5432
    DB_NAME: dev_db
    DB_NAME_DEV: dev_db
    MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/migrations_manifest.txt'
    DML_MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/dml_migrations_manifest.txt'
    DDL_TYPES_MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/ddl_types_manifest.txt'
    DDL_TABLES_MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/ddl_tables_manifest.txt'
    DDL_VIEWS_MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/ddl_views_manifest.txt'
    DDL_FUNCTIONS_MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/ddl_functions_manifest.txt'
    MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/schema;file:///builds/milmove/mymove/migrations/app/secure'
    DDL_TYPES_MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/ddl_migrations/ddl_types'
    DDL_TABLES_MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/ddl_migrations/ddl_tables'
    DDL_VIEWS_MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/ddl_migrations/ddl_views'
    DDL_FUNCTIONS_MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/ddl_migrations/ddl_functions'
    EIA_KEY: db2522a43820268a41a802a16ae9fd26 # dummy key generated with openssl rand -hex 16
    ENVIRONMENT: development
    DOD_CA_PACKAGE: /builds/milmove/mymove/config/tls/milmove-cert-bundle.p7b
    POSTGRES_PASSWORD: mysecretpassword
    POSTGRES_DB: test_db

    IWS_RBS_HOST: 'pkict.dmdc.osd.mil'
    DTOD_USE_MOCK: 'true'
  needs:
    - prep_integration_microservice
  before_script:
      - *setup_milmove_env
      - *e2e_tests_playwright
  script:
    - echo "TODO Add steps"
    - echo "integration_test_office"
    - ./node_modules/.bin/playwright test playwright/tests/office \
        --reporter=html,junit \
        --trace=on \
        --shard="${CI_NODE_INDEX}/${CI_NODE_TOTAL}" \
        --workers=1 >> $CI_PROJECT_DIR/playwright_test_office.output 2>&1
  artifacts:
    paths:
      - playwright-report/
      - complete-playwright-report.zip
      - playwright-results.xml
      - $CI_PROJECT_DIR/playwright_test_office.output
    when: always
  after_script:
    - *announce_failure
  rules:
   - if: '$INTEGRATION_TEST_ALLOW_FAILURE == "true"'
     allow_failure: true
   - if: '$INTEGRATION_TEST_ALLOW_FAILURE == "false"'
     allow_failure: true # allow failure for now
   - *check_integration_ignore_branch

integration_test_e2e_generic:
  stage: test
  interruptible: true
  cache:
    - <<: *yarn_cache
    - <<: *node_cache
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  image: $DOCKER_APP_IMAGE
  services:
    - name: $postgres
    - name: $redis
    - name: registry.csde.caci.com/milmove/mymove:e2e-${CI_COMMIT_SHORT_SHA}
      alias: milmovelocal,officelocal,adminlocal,primelocal
      entrypoint: ["/bin/milmove"]
      command: ["serve"]
  variables:
    KUBERNETES_SERVICE_CPU_REQUEST: "2"
    KUBERNETES_SERVICE_MEMORY_REQUEST: "4Gi"
    KUBERNETES_SERVICE_MEMORY_LIMIT: "4Gi"
    KUBERNETES_SERVICE_EPHEMERAL_STORAGE_REQUEST: "1Gi"
    CI_DEBUG_SERVICES: "true"
    KUBERNETES_CPU_REQUEST: "2"
    KUBERNETES_MEMORY_REQUEST: "12Gi"
    KUBERNETES_MEMORY_LIMIT: "12Gi"
    APPLICATION: app
    DB_PASSWORD: mysecretpassword
    DB_USER_LOW_PRIV: crud
    DB_PASSWORD_LOW_PRIV: mysecretpassword
    DB_USER: postgres
    DB_HOST: localhost
    DB_PORT: 5432
    DB_NAME: dev_db
    DB_NAME_DEV: dev_db
    MIGRATION_MANIFEST: '/builds/milmove/mymove/migrations/app/migrations_manifest.txt'
    MIGRATION_PATH: 'file:///builds/milmove/mymove/migrations/app/schema;file:///builds/milmove/mymove/migrations/app/secure'
    EIA_KEY: db2522a43820268a41a802a16ae9fd26 # dummy key generated with openssl rand -hex 16
    ENVIRONMENT: development
    DOD_CA_PACKAGE: /builds/milmove/mymove/config/tls/milmove-cert-bundle.p7b
    POSTGRES_PASSWORD: mysecretpassword
    POSTGRES_DB: test_db
  needs:
    - prep_integration_microservice
  before_script:
      - *setup_milmove_env
      - *e2e_tests_playwright
      - apt-get update -y
      #- apt-get install -y golang-go
      #- go install your/go/app # Replace with your actual Go app path
      #- go mod download
      #- go build -o myapp . # Build your Go application
      #- ./myapp migrate up # Run database migrations
      - npm install
  script:
    - echo "TODO Add steps"
    - echo "integration_test_office"
    - ./node_modules/.bin/playwright test playwright/tests/office \
        --reporter=html,junit \
        --trace=on \
        --workers=1
  artifacts:
    paths:
      - playwright-report/
      - complete-playwright-report.zip
      - playwright-results.xml
    when: always
  after_script:
    - *announce_failure
  rules:
   - if: '$INTEGRATION_TEST_ALLOW_FAILURE == "true"'
     allow_failure: true
   - if: '$INTEGRATION_TEST_ALLOW_FAILURE == "false"'
     allow_failure: true # allow failure for now
   - *check_integration_ignore_branch

###############################################################
## DP3 Env push and deploy stages all off of setting dp3 env ##
###############################################################
build_push_app_dp3:
  stage: push
  interruptible: true
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  environment: $DP3_ENV
  image:
    name: gcr.io/kaniko-project/executor:v1.14.0-debug
    entrypoint: [""]
  needs:
     - compile_app_client
     - compile_app_server
  before_script:
    - *setup_aws_vars_dp3
    - *setup_release_dp3
    - *kaniko_before_setup
  script:
    - echo "Building and Pushing app Docker image..."
    - /kaniko/executor --context "${CI_PROJECT_DIR}/" --dockerfile "${CI_PROJECT_DIR}/${APP_DOCKER_FILE}" --destination "${ECR_REPOSITORY_URI}/app:git-$CI_COMMIT_SHORT_SHA"
  after_script:
    - *announce_failure
  rules:
    - *check_dp3

build_push_migrations_dp3:
  stage: push
  interruptible: true
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  environment: $DP3_ENV
  image:
    name: gcr.io/kaniko-project/executor:v1.14.0-debug
    entrypoint: [""]
  needs:
    - compile_app_server
    - compile_app_client
  before_script:
    - *setup_aws_vars_dp3
    - *setup_release_dp3
    - *kaniko_before_setup
  script:
    - echo "Building and Pushing migrations Docker image..."
    - /kaniko/executor --context "${CI_PROJECT_DIR}/" --dockerfile "${CI_PROJECT_DIR}/Dockerfile.migrations" --destination "${ECR_REPOSITORY_URI}/app-migrations:git-$CI_COMMIT_SHORT_SHA"
  after_script:
    - *announce_failure
  rules:
    - *check_dp3

build_push_tasks_dp3:
  stage: push
  interruptible: true
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  environment: $DP3_ENV
  image:
    name: gcr.io/kaniko-project/executor:v1.14.0-debug
    entrypoint: [""]
  needs:
    - compile_app_server
    - compile_app_client
  before_script:
    - *setup_aws_vars_dp3
    - *setup_release_dp3
    - *kaniko_before_setup
  script:
    - echo "Building tasks Docker image..."
    - /kaniko/executor --context "${CI_PROJECT_DIR}/" --dockerfile "${CI_PROJECT_DIR}/${TASK_DOCKER_FILE}" --destination "${ECR_REPOSITORY_URI}/app-tasks:git-$CI_COMMIT_SHORT_SHA"
  after_script:
    - *announce_failure
  rules:
    - *check_dp3

push_otel_collector_image_dp3:
  stage: push
  interruptible: true
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  environment: $DP3_ENV
  before_script:
    - *setup_aws_vars_dp3
    - *setup_release_dp3
  image:
    name: $DOCKER_BASE_IMAGE
    entrypoint: [""]
  needs:
    - compile_app_server
    - compile_app_client
  script:
    - echo "Logging in to DockerHub with Crane..."
    - echo "${DOCKERHUB_PASSWORD}" | crane auth login docker.io -u "${DOCKERHUB_USERNAME}" --password-stdin

    - echo "Pulling the AWS OTel Collector image from DockerHub..."
    - crane pull ${ECR_REPOSITORY_OTEL}:${OTEL_VERSION} image.tar

    - echo "Logging into AWS ECR with Crane..."
    - aws ecr get-login-password --region $AWS_DEFAULT_REGION | crane auth login ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com -u AWS --password-stdin

    - echo "Pushing the image to our private ECR using Crane..."
    - crane push image.tar ${ECR_REPOSITORY_URI}/otel-collector:${OTEL_IMAGE_TAG}

    - echo "Cleaning up temporary image file..."
    - rm image.tar
  allow_failure: false
  after_script:
    - *announce_failure
  rules:
    - *check_dp3

deploy_migrations_dp3:
  stage: deploy
  resource_group: $DP3_ENV_migration
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  environment: $DP3_ENV
  image:
    name: $DOCKER_APP_IMAGE
    entrypoint: [""]
  needs:
    - push_otel_collector_image_dp3
    - build_push_migrations_dp3
    - compile_app_server
    - compile_app_client
  before_script:
    - *setup_aws_vars_dp3
    - *setup_release_dp3
  script:
    # Step 1: Get the Digest
    - echo "Getting Digest from AWS"
    - export ECR_DIGEST=$(aws ecr describe-images --repository-name app-migrations --image-ids imageTag=git-$CI_COMMIT_SHORT_SHA --query 'imageDetails[0].imageDigest' --output text)
    # Step 2: Ensure exclusive execution and Snapshot
    - echo "Snapshotting database"
    - ./scripts/rds-snapshot-app-db "$APP_ENVIRONMENT"
    # Step 3: Run migrations
    - echo "Running migrations"
    - ./scripts/ecs-run-app-migrations-container "${ECR_REPOSITORY_URI}/app-migrations@${ECR_DIGEST}" "${APP_ENVIRONMENT}"
  after_script:
    - *announce_failure
  rules:
    - *check_dp3

deploy_tasks_dp3:
  stage: deploy
  resource_group: $DP3_ENV_task
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  environment: $DP3_ENV
  image:
    name: $DOCKER_APP_IMAGE
    entrypoint: [""]
  needs:
    - deploy_migrations_dp3
    - build_push_tasks_dp3
    - compile_app_server
    - compile_app_client
  before_script:
    - *setup_aws_vars_dp3
    - *setup_release_dp3
  script:
    - echo "Getting Digest from AWS"
    - export ECR_DIGEST=$(aws ecr describe-images --repository-name app-tasks --image-ids imageTag=git-$CI_COMMIT_SHORT_SHA --query 'imageDetails[0].imageDigest' --output text)
    - echo "Deploying GHC fuel price data task service"
    - ./scripts/ecs-deploy-task-container save-ghc-fuel-price-data "${ECR_REPOSITORY_URI}/app-tasks@${ECR_DIGEST}" "${APP_ENVIRONMENT}"
    - echo "Deploying payment reminder email task service"
    - ./scripts/ecs-deploy-task-container send-payment-reminder "${ECR_REPOSITORY_URI}/app-tasks@${ECR_DIGEST}" "${APP_ENVIRONMENT}"
    - echo "Deploying process TPPS task service"
    - ./scripts/ecs-deploy-task-container process-tpps "${ECR_REPOSITORY_URI}/app-tasks@${ECR_DIGEST}" "${APP_ENVIRONMENT}"
    - echo "Deploy connect to GEX via SFTP service"
    - ./scripts/ecs-deploy-task-container connect-to-gex-via-sftp "${ECR_REPOSITORY_URI}/app-tasks@${ECR_DIGEST}" "${APP_ENVIRONMENT}"
    # - echo "Deploy post to GEX service"
    # - ./scripts/ecs-deploy-task-container post-file-to-gex "${ECR_REPOSITORY_URI}/app-tasks@${ECR_DIGEST}" "${APP_ENVIRONMENT}"
    # - echo "Deploy process EDIs service"
    # - ./scripts/ecs-deploy-task-container process-edis "${ECR_REPOSITORY_URI}/app-tasks@${ECR_DIGEST}" "${APP_ENVIRONMENT}"
  after_script:
    - *announce_failure
  rules:
    - *check_dp3

deploy_app_client_tls_dp3:
  stage: deploy
  resource_group: $DP3_ENV_client
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  environment: $DP3_ENV
  image:
    name: $DOCKER_APP_IMAGE
    entrypoint: [""]
  needs:
    - deploy_migrations_dp3
    - push_otel_collector_image_dp3
    - compile_app_server
    - compile_app_client
  variables:
    OPEN_TELEMETRY_SIDECAR: "true"
    HEALTH_CHECK: "true"
  before_script:
    - *setup_aws_vars_dp3
    - *setup_tls_vars_dp3
    - *setup_release_dp3
  script:
    # - echo "Comparing against deployed commit"
    # - ./scripts/compare-deployed-commit "" $CI_COMMIT_SHA ${TLS_KEY} ${TLS_CERT} ${TLS_CA}
    - echo "Getting Digest from AWS"
    - export ECR_DIGEST=$(aws ecr describe-images --repository-name app --image-ids imageTag=git-$CI_COMMIT_SHORT_SHA --query 'imageDetails[0].imageDigest' --output text)
    - echo "Getting otel collector Digest from AWS"
    - export OTEL_ECR_DIGEST=$(aws ecr describe-images --repository-name otel-collector --image-ids imageTag=${OTEL_IMAGE_TAG} --query 'imageDetails[0].imageDigest' --output text)
    - export OTEL_COLLECTOR_IMAGE="${ECR_REPOSITORY_URI}/otel-collector@${OTEL_ECR_DIGEST}"
    - echo "Deploying app-client-tls service"
    - ./scripts/ecs-deploy-service-container app-client-tls "${ECR_REPOSITORY_URI}/app@${ECR_DIGEST}" "${APP_ENVIRONMENT}" "/bin/milmove serve"
    - echo "Running Health Check"
    - bin/health-checker --schemes https --hosts api.$APP_ENVIRONMENT.dp3.us --key ${TLS_KEY} --cert ${TLS_CERT} --ca ${TLS_CA} --tries 10 --backoff 3 --log-level info --timeout 5m
    - echo "Running TLS Check"
    - bin/tls-checker --schemes https --hosts api.$APP_ENVIRONMENT.dp3.us --key ${TLS_KEY} --cert ${TLS_CERT} --ca ${TLS_CA} --log-level info --timeout 15m
    - echo "Checking deployed commits"
    - ./scripts/check-deployed-commit "api.$APP_ENVIRONMENT.dp3.us" "$CI_COMMIT_SHA" ${TLS_KEY} ${TLS_CERT} ${TLS_CA}
  after_script:
    - *announce_failure
  rules:
    - *check_dp3

deploy_app_dp3:
  stage: deploy
  resource_group: $DP3_ENV_app
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  environment: $DP3_ENV
  image:
    name: $DOCKER_APP_IMAGE
    entrypoint: [""]
  needs:
    - build_push_app_dp3
    - deploy_migrations_dp3
    - compile_app_server
    - compile_app_client
  variables:
    OPEN_TELEMETRY_SIDECAR: "true"
    HEALTH_CHECK: "true"
  before_script:
    - *setup_tls_vars_dp3
    - *setup_aws_vars_dp3
    - *setup_release_dp3
  script:
    - echo "Comparing against deployed commit"
    # - ./scripts/compare-deployed-commit "" "$CI_COMMIT_SHA" "$TLS_KEY" "$TLS_CERT" "$TLS_CA"
    - echo "Creating .go-version file if not already present"
    - |
      if [ -f ".go-version" ]; then
        echo ".go-version already exists, no need to re-create"
      else
        GO_VERSION=$(awk '/golang/ { print $2 }' .tool-versions)
        echo "Creating .go-version using version ${GO_VERSION}"
        echo $GO_VERSION > .go-version
      fi
    - echo "Getting Digest from AWS"
    - export ECR_DIGEST=$(aws ecr describe-images --repository-name app --image-ids imageTag=git-$CI_COMMIT_SHORT_SHA --query 'imageDetails[0].imageDigest' --output text)
    - echo "Getting otel collector digest from AWS"
    - export OTEL_ECR_DIGEST=$(aws ecr describe-images --repository-name otel-collector --image-ids imageTag=git-${OTEL_VERSION}-${CI_COMMIT_SHORT_SHA} --query 'imageDetails[0].imageDigest' --output text)
    - export OTEL_COLLECTOR_IMAGE="${ECR_REPOSITORY_URI}/otel-collector@${OTEL_ECR_DIGEST}"
    - echo "Deploying app service"
    - ./scripts/ecs-deploy-service-container app "${ECR_REPOSITORY_URI}/app@${ECR_DIGEST}" "${APP_ENVIRONMENT}" "/bin/milmove serve"
    - echo "Running Health Check"
    - bin/health-checker --schemes https --hosts my.$DP3_ENV.dp3.us,office.$DP3_ENV.dp3.us,admin.$DP3_ENV.dp3.us --tries 10 --backoff 3 --log-level info --timeout 5m
    - echo "Running TLS Check"
    - bin/tls-checker --schemes https --hosts my.$DP3_ENV.dp3.us,office.$DP3_ENV.dp3.us,admin.$DP3_ENV.dp3.us --log-level info --timeout 15m
    - echo "Checking deployed commits"
    - ./scripts/check-deployed-commit "my.$DP3_ENV.dp3.us,office.$DP3_ENV.dp3.us,admin.$DP3_ENV.dp3.us" "$CI_COMMIT_SHA"
  after_script:
    - *announce_failure
  rules:
    - *check_dp3

########################################################
## STG push and deploy stages all off of main only    ##
########################################################
build_push_app_stg:
  stage: push
  interruptible: true
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  environment: stg
  image:
    name: gcr.io/kaniko-project/executor:v1.14.0-debug
    entrypoint: [""]
  needs:
      - compile_app_client
      - compile_app_server
      - client_test_coverage
      - server_test_coverage
      - pre_test
      - integration_tests
  before_script:
    - *setup_aws_vars_stg
    - *setup_release_stg
    - *kaniko_before_setup
  script:
    - echo "Building and Pushing app Docker image..."
    - /kaniko/executor --context "${CI_PROJECT_DIR}/" --dockerfile "${CI_PROJECT_DIR}/${APP_DOCKER_FILE}" --destination "${ECR_REPOSITORY_URI}/app:git-$CI_COMMIT_SHORT_SHA"
  after_script:
    - *announce_failure
  rules:
  - *check_main

build_push_migrations_stg:
  stage: push
  interruptible: true
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  environment: stg
  image:
    name: gcr.io/kaniko-project/executor:v1.14.0-debug
    entrypoint: [""]
  needs:
    - compile_app_server
    - compile_app_client
    - client_test_coverage
    - server_test_coverage
    - pre_test
    - integration_tests
  before_script:
    - *setup_aws_vars_stg
    - *setup_release_stg
    - *kaniko_before_setup
  script:
    - echo "Building and Pushing migrations Docker image..."
    - /kaniko/executor --context "${CI_PROJECT_DIR}/" --dockerfile "${CI_PROJECT_DIR}/Dockerfile.migrations" --destination "${ECR_REPOSITORY_URI}/app-migrations:git-$CI_COMMIT_SHORT_SHA"
  after_script:
    - *announce_failure
  rules:
  - *check_main

build_push_tasks_stg:
  stage: push
  interruptible: true
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  environment: stg
  image:
    name: gcr.io/kaniko-project/executor:v1.14.0-debug
    entrypoint: [""]
  needs:
    - compile_app_server
    - compile_app_client
    - client_test_coverage
    - server_test_coverage
    - pre_test
    - integration_tests
  before_script:
    - *setup_aws_vars_stg
    - *setup_release_stg
    - *kaniko_before_setup
  script:
    - echo "Building tasks Docker image..."
    - /kaniko/executor --context "${CI_PROJECT_DIR}/" --dockerfile "${CI_PROJECT_DIR}/${TASK_DOCKER_FILE}" --destination "${ECR_REPOSITORY_URI}/app-tasks:git-$CI_COMMIT_SHORT_SHA"
  after_script:
    - *announce_failure
  rules:
  - *check_main

push_otel_collector_image_stg:
  stage: push
  interruptible: true
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  environment: stg
  image:
    name: $DOCKER_BASE_IMAGE
    entrypoint: [""]
  needs:
    - compile_app_server
    - compile_app_client
  before_script:
    - *setup_aws_vars_stg
    - *setup_release_stg
  script:
    - echo "Logging in to DockerHub with Crane..."
    - echo "${DOCKERHUB_PASSWORD}" | crane auth login docker.io -u "${DOCKERHUB_USERNAME}" --password-stdin

    - echo "Pulling the AWS OTel Collector image from DockerHub..."
    - crane pull ${ECR_REPOSITORY_OTEL}:${OTEL_VERSION} image.tar

    - echo "Logging into AWS ECR with Crane..."
    - aws ecr get-login-password --region $AWS_DEFAULT_REGION | crane auth login ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com -u AWS --password-stdin

    - echo "Pushing the image to our private ECR using Crane..."
    - crane push image.tar ${ECR_REPOSITORY_URI}/otel-collector:${OTEL_IMAGE_TAG}

    - echo "Cleaning up temporary image file..."
    - rm image.tar
  allow_failure: false
  after_script:
    - *announce_failure
  rules:
    - *check_main

deploy_migrations_stg:
  stage: deploy
  resource_group: staging_migration
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  environment: stg
  image:
    name: $DOCKER_APP_IMAGE
    entrypoint: [""]
  needs:
    - push_otel_collector_image_stg
    - build_push_migrations_stg
    - compile_app_server
    - compile_app_client
  before_script:
    - *setup_aws_vars_stg
    - *setup_release_stg
  script:
    # Step 1: Get the Digest
    - echo "Getting Digest from AWS"
    - export ECR_DIGEST=$(aws ecr describe-images --repository-name app-migrations --image-ids imageTag=git-$CI_COMMIT_SHORT_SHA --query 'imageDetails[0].imageDigest' --output text)
    # Step 2: Ensure exclusive execution and Snapshot
    - echo "Snapshotting database"
    - ./scripts/rds-snapshot-app-db "$APP_ENVIRONMENT"
    # Step 3: Run migrations
    - echo "Running migrations"
    - ./scripts/ecs-run-app-migrations-container "${ECR_REPOSITORY_URI}/app-migrations@${ECR_DIGEST}" "${APP_ENVIRONMENT}"
  after_script:
    - *announce_failure
  rules:
    - *check_main

deploy_tasks_stg:
  stage: deploy
  resource_group: staging_task
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  environment: stg
  image:
    name: $DOCKER_APP_IMAGE
    entrypoint: [""]
  needs:
    - deploy_migrations_stg
    - build_push_tasks_stg
    - compile_app_server
    - compile_app_client
  before_script:
    - *setup_aws_vars_stg
    - *setup_release_stg
  script:
    - echo "Getting Digest from AWS"
    - export ECR_DIGEST=$(aws ecr describe-images --repository-name app-tasks --image-ids imageTag=git-$CI_COMMIT_SHORT_SHA --query 'imageDetails[0].imageDigest' --output text)
    - echo "Deploying GHC fuel price data task service"
    - ./scripts/ecs-deploy-task-container save-ghc-fuel-price-data "${ECR_REPOSITORY_URI}/app-tasks@${ECR_DIGEST}" "${APP_ENVIRONMENT}"
    - echo "Deploying payment reminder email task service"
    - ./scripts/ecs-deploy-task-container send-payment-reminder "${ECR_REPOSITORY_URI}/app-tasks@${ECR_DIGEST}" "${APP_ENVIRONMENT}"
    - echo "Deploying process TPPS task service"
    - ./scripts/ecs-deploy-task-container process-tpps "${ECR_REPOSITORY_URI}/app-tasks@${ECR_DIGEST}" "${APP_ENVIRONMENT}"
    - echo "Deploy connect to GEX via SFTP service"
    - ./scripts/ecs-deploy-task-container connect-to-gex-via-sftp "${ECR_REPOSITORY_URI}/app-tasks@${ECR_DIGEST}" "${APP_ENVIRONMENT}"
    - echo "Deploy post to GEX service"
    - ./scripts/ecs-deploy-task-container post-file-to-gex "${ECR_REPOSITORY_URI}/app-tasks@${ECR_DIGEST}" "${APP_ENVIRONMENT}"
    - echo "Deploy process EDIs service"
    - ./scripts/ecs-deploy-task-container process-edis "${ECR_REPOSITORY_URI}/app-tasks@${ECR_DIGEST}" "${APP_ENVIRONMENT}"
  after_script:
    - *announce_failure
  rules:
    - *check_main

deploy_app_client_tls_stg:
  stage: deploy
  resource_group: staging_client
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  environment: stg
  image:
    name: $DOCKER_APP_IMAGE
    entrypoint: [""]
  needs:
    - deploy_migrations_stg
    - push_otel_collector_image_stg
    - compile_app_server
    - compile_app_client
  variables:
    OPEN_TELEMETRY_SIDECAR: "true"
    HEALTH_CHECK: "true"
  before_script:
    - *setup_tls_vars_stg
    - *setup_aws_vars_stg
    - *setup_release_stg
  script:
    # - echo "Comparing against deployed commit"
    # - ./scripts/compare-deployed-commit "" $CI_COMMIT_SHA ${TLS_KEY} ${TLS_CERT} ${TLS_CA}
    - echo "Getting Digest from AWS"
    - export ECR_DIGEST=$(aws ecr describe-images --repository-name app --image-ids imageTag=git-$CI_COMMIT_SHORT_SHA --query 'imageDetails[0].imageDigest' --output text)
    - echo "Getting otel collector Digest from AWS"
    - export OTEL_ECR_DIGEST=$(aws ecr describe-images --repository-name otel-collector --image-ids imageTag=${OTEL_IMAGE_TAG} --query 'imageDetails[0].imageDigest' --output text)
    - export OTEL_COLLECTOR_IMAGE="${ECR_REPOSITORY_URI}/otel-collector@${OTEL_ECR_DIGEST}"
    - echo "Deploying app-client-tls service"
    - ./scripts/ecs-deploy-service-container app-client-tls "${ECR_REPOSITORY_URI}/app@${ECR_DIGEST}" "${APP_ENVIRONMENT}" "/bin/milmove serve"
    #TODO: fix domain make dynamic and pass in preferred
    - echo "Running Health Check"
    - bin/health-checker --schemes https --hosts api.$APP_ENVIRONMENT.move.mil --key ${TLS_KEY} --cert ${TLS_CERT} --ca ${TLS_CA} --tries 10 --backoff 3 --log-level info --timeout 5m
    - echo "Running TLS Check"
    - bin/tls-checker --schemes https --hosts api.$APP_ENVIRONMENT.move.mil --key ${TLS_KEY} --cert ${TLS_CERT} --ca ${TLS_CA} --log-level info --timeout 15m
    - echo "Checking deployed commits"
    - ./scripts/check-deployed-commit "api.$APP_ENVIRONMENT.move.mil" "$CI_COMMIT_SHA" ${TLS_KEY} ${TLS_CERT} ${TLS_CA}
  after_script:
    - *announce_failure
  rules:
    - *check_main

deploy_app_stg:
  stage: deploy
  resource_group: staging_app
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  environment: stg
  image:
    name: $DOCKER_APP_IMAGE
    entrypoint: [""]
  needs:
    - build_push_app_stg
    - deploy_migrations_stg
    - compile_app_server
    - compile_app_client
  variables:
    OPEN_TELEMETRY_SIDECAR: "true"
    HEALTH_CHECK: "true"
  before_script:
    - *setup_tls_vars_stg
    - *setup_aws_vars_stg
    - *setup_release_stg
  script:
    - echo "Comparing against deployed commit"
    # - ./scripts/compare-deployed-commit "" "$CI_COMMIT_SHA" "$TLS_KEY" "$TLS_CERT" "$TLS_CA"
    - echo "Creating .go-version file if not already present"
    - |
      if [ -f ".go-version" ]; then
        echo ".go-version already exists, no need to re-create"
      else
        GO_VERSION=$(awk '/golang/ { print $2 }' .tool-versions)
        echo "Creating .go-version using version ${GO_VERSION}"
        echo $GO_VERSION > .go-version
      fi
    - echo "Getting Digest from AWS"
    - export ECR_DIGEST=$(aws ecr describe-images --repository-name app --image-ids imageTag=git-$CI_COMMIT_SHORT_SHA --query 'imageDetails[0].imageDigest' --output text)
    - echo "Getting otel collector digest from AWS"
    - export OTEL_ECR_DIGEST=$(aws ecr describe-images --repository-name otel-collector --image-ids imageTag=${OTEL_IMAGE_TAG} --query 'imageDetails[0].imageDigest' --output text)
    - export OTEL_COLLECTOR_IMAGE="${ECR_REPOSITORY_URI}/otel-collector@${OTEL_ECR_DIGEST}"
    - echo "Deploying app service"
    - ./scripts/ecs-deploy-service-container app "${ECR_REPOSITORY_URI}/app@${ECR_DIGEST}" "${APP_ENVIRONMENT}" "/bin/milmove serve"
    #TODO: fix domain make dynamic and pass in preferred
    - echo "Running Health Check"
    - bin/health-checker --schemes https --hosts my.$APP_ENVIRONMENT.move.mil,office.$APP_ENVIRONMENT.move.mil,admin.$APP_ENVIRONMENT.move.mil --tries 10 --backoff 3 --log-level info --timeout 5m
    - echo "Running TLS Check"
    - bin/tls-checker --schemes https --hosts my.$APP_ENVIRONMENT.move.mil,office.$APP_ENVIRONMENT.move.mil,admin.$APP_ENVIRONMENT.move.mil --log-level info --timeout 15m
    - echo "Checking deployed commits"
    - ./scripts/check-deployed-commit "my.$APP_ENVIRONMENT.move.mil,office.$APP_ENVIRONMENT.move.mil,admin.$APP_ENVIRONMENT.move.mil" "$CI_COMMIT_SHA"
  after_script:
    - *announce_failure
  rules:
    - *check_main

##############################################################################
## PROD push and deploy stages all dependent on prod_approval manual stage  ##
##############################################################################
prod_approval:
  stage: prod_approval
  resource_group: production
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  environment: prd_approval
  needs:
      - compile_app_client
      - compile_app_server
      - deploy_app_stg
      - deploy_app_client_tls_stg
  script:
    - echo "No Op Prd"
  after_script:
    - *announce_failure
  rules:
  - *check_main

build_push_app_prd:
  stage: push_prd
  resource_group: production_app
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  environment: prd
  image:
    name: gcr.io/kaniko-project/executor:v1.14.0-debug
    entrypoint: [""]
  needs:
    - prod_approval
    - compile_app_server
    - compile_app_client
  before_script:
      - *setup_aws_vars_prd
      - *setup_release_prd
      - *kaniko_before_setup
  script:
    - echo "Building and Pushing app Docker image..."
    - /kaniko/executor --context "${CI_PROJECT_DIR}/" --dockerfile "${CI_PROJECT_DIR}/${APP_DOCKER_FILE}" --destination "${ECR_REPOSITORY_URI}/app:git-$CI_COMMIT_SHORT_SHA"
  after_script:
    - *announce_failure
  rules:
    - *check_main

build_push_migrations_prd:
  stage: push_prd
  resource_group: production_migration
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  environment: prd
  image:
    name: gcr.io/kaniko-project/executor:v1.14.0-debug
    entrypoint: [""]
  needs:
    - prod_approval
    - compile_app_server
    - compile_app_client
  before_script:
    - *setup_aws_vars_prd
    - *setup_release_prd
    - *kaniko_before_setup
  script:
    - echo "Building and Pushing migrations Docker image..."
    - /kaniko/executor --context "${CI_PROJECT_DIR}/" --dockerfile "${CI_PROJECT_DIR}/Dockerfile.migrations" --destination "${ECR_REPOSITORY_URI}/app-migrations:git-$CI_COMMIT_SHORT_SHA"
  after_script:
    - *announce_failure
  rules:
   - *check_main

build_push_tasks_prd:
  stage: push_prd
  resource_group: production_task
  environment: prd
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  image:
    name: gcr.io/kaniko-project/executor:v1.14.0-debug
    entrypoint: [""]
  needs:
    - prod_approval
    - compile_app_server
    - compile_app_client
  before_script:
    - *setup_aws_vars_prd
    - *setup_release_prd
    - *kaniko_before_setup
  script:
    - echo "Building tasks Docker image..."
    - /kaniko/executor --context "${CI_PROJECT_DIR}/" --dockerfile "${CI_PROJECT_DIR}/${TASK_DOCKER_FILE}" --destination "${ECR_REPOSITORY_URI}/app-tasks:git-$CI_COMMIT_SHORT_SHA"
  after_script:
    - *announce_failure
  rules:
    - *check_main

push_otel_collector_image_prd:
  stage: push_prd
  resource_group: production_otel
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  environment: prd
  image:
    name: $DOCKER_BASE_IMAGE
    entrypoint: [""]
  needs:
    - prod_approval
    - compile_app_server
    - compile_app_client
  before_script:
    - *setup_aws_vars_prd
    - *setup_release_prd
  script:
    - echo "Logging in to DockerHub with Crane..."
    - echo "${DOCKERHUB_PASSWORD}" | crane auth login docker.io -u "${DOCKERHUB_USERNAME}" --password-stdin

    - echo "Pulling the AWS OTel Collector image from DockerHub..."
    - crane pull ${ECR_REPOSITORY_OTEL}:${OTEL_VERSION} image.tar

    - echo "Logging into AWS ECR with Crane..."
    - aws ecr get-login-password --region $AWS_DEFAULT_REGION | crane auth login ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com -u AWS --password-stdin

    - echo "Pushing the image to our private ECR using Crane..."
    - crane push image.tar ${ECR_REPOSITORY_URI}/otel-collector:${OTEL_IMAGE_TAG}

    - echo "Cleaning up temporary image file..."
    - rm image.tar
  allow_failure: false
  after_script:
    - *announce_failure
  rules:
  - *check_main

deploy_migrations_prd:
  stage: deploy_prd
  resource_group: production_migration
  environment: prd
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  image:
    name: $DOCKER_APP_IMAGE
    entrypoint: [""]
  needs:
    - push_otel_collector_image_prd
    - build_push_migrations_prd
    - compile_app_server
    - compile_app_client
  before_script:
    - *setup_aws_vars_prd
    - *setup_release_prd
  script:
    # Step 1: Get the Digest
    - echo "Getting Digest from AWS"
    - export ECR_DIGEST=$(aws ecr describe-images --repository-name app-migrations --image-ids imageTag=git-$CI_COMMIT_SHORT_SHA --query 'imageDetails[0].imageDigest' --output text)
    # Step 2: Ensure exclusive execution and Snapshot
    - echo "Snapshotting database"
    - ./scripts/rds-snapshot-app-db "$APP_ENVIRONMENT"
    # Step 3: Run migrations
    - echo "Running migrations"
    - ./scripts/ecs-run-app-migrations-container "${ECR_REPOSITORY_URI}/app-migrations@${ECR_DIGEST}" "${APP_ENVIRONMENT}"
  after_script:
    - *announce_failure
  rules:
    - *check_main

deploy_tasks_prd:
  stage: deploy_prd
  resource_group: production_task
  environment: prd
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  image:
    name: $DOCKER_APP_IMAGE
    entrypoint: [""]
  needs:
    - deploy_migrations_prd
    - build_push_tasks_prd
    - compile_app_server
    - compile_app_client
  before_script:
    - *setup_aws_vars_prd
    - *setup_release_prd
  script:
    - echo "Getting Digest from AWS"
    - export ECR_DIGEST=$(aws ecr describe-images --repository-name app-tasks --image-ids imageTag=git-$CI_COMMIT_SHORT_SHA --query 'imageDetails[0].imageDigest' --output text)
    - echo "Deploying GHC fuel price data task service"
    - ./scripts/ecs-deploy-task-container save-ghc-fuel-price-data "${ECR_REPOSITORY_URI}/app-tasks@${ECR_DIGEST}" "${APP_ENVIRONMENT}"
    - echo "Deploying payment reminder email task service"
    - ./scripts/ecs-deploy-task-container send-payment-reminder "${ECR_REPOSITORY_URI}/app-tasks@${ECR_DIGEST}" "${APP_ENVIRONMENT}"
    - echo "Deploying process TPPS task service"
    - ./scripts/ecs-deploy-task-container process-tpps "${ECR_REPOSITORY_URI}/app-tasks@${ECR_DIGEST}" "${APP_ENVIRONMENT}"
    - echo "Deploy connect to GEX via SFTP service"
    - ./scripts/ecs-deploy-task-container connect-to-gex-via-sftp "${ECR_REPOSITORY_URI}/app-tasks@${ECR_DIGEST}" "${APP_ENVIRONMENT}"
    - echo "Deploy post to GEX service"
    - ./scripts/ecs-deploy-task-container post-file-to-gex "${ECR_REPOSITORY_URI}/app-tasks@${ECR_DIGEST}" "${APP_ENVIRONMENT}"
    - echo "Deploy process EDIs service"
    - ./scripts/ecs-deploy-task-container process-edis "${ECR_REPOSITORY_URI}/app-tasks@${ECR_DIGEST}" "${APP_ENVIRONMENT}"
  after_script:
    - *announce_failure
  rules:
    - *check_main

deploy_app_client_tls_prd:
  stage: deploy_prd
  resource_group: production_client
  environment: prd
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  image:
    name: $DOCKER_APP_IMAGE
    entrypoint: [""]
  needs:
    - deploy_migrations_prd
    - push_otel_collector_image_prd
    - compile_app_server
    - compile_app_client
  variables:
    OPEN_TELEMETRY_SIDECAR: "true"
    HEALTH_CHECK: "true"
  before_script:
    - *setup_tls_vars_prd
    - *setup_aws_vars_prd
    - *setup_release_prd
  script:
    # - echo "Comparing against deployed commit"
    # - ./scripts/compare-deployed-commit "" $CI_COMMIT_SHA ${TLS_KEY} ${TLS_CERT} ${TLS_CA}
    - echo "Getting Digest from AWS"
    - export ECR_DIGEST=$(aws ecr describe-images --repository-name app --image-ids imageTag=git-$CI_COMMIT_SHORT_SHA --query 'imageDetails[0].imageDigest' --output text)
    - echo "Getting otel collector Digest from AWS"
    - export OTEL_ECR_DIGEST=$(aws ecr describe-images --repository-name otel-collector --image-ids imageTag=${OTEL_IMAGE_TAG} --query 'imageDetails[0].imageDigest' --output text)
    - export OTEL_COLLECTOR_IMAGE="${ECR_REPOSITORY_URI}/otel-collector@${OTEL_ECR_DIGEST}"
    - echo "Deploying app-client-tls service"
    - ./scripts/ecs-deploy-service-container app-client-tls "${ECR_REPOSITORY_URI}/app@${ECR_DIGEST}" "${APP_ENVIRONMENT}" "/bin/milmove serve"
    #TODO: fix domain make dynamic and pass in preferred
    - echo "Running Health Check"
    - bin/health-checker --schemes https --hosts api.move.mil --key ${TLS_KEY} --cert ${TLS_CERT} --ca ${TLS_CA} --tries 10 --backoff 3 --log-level info --timeout 5m
    - echo "Running TLS Check"
    - bin/tls-checker --schemes https --hosts api.move.mil --key ${TLS_KEY} --cert ${TLS_CERT} --ca ${TLS_CA} --log-level info --timeout 15m
    - echo "Checking deployed commits"
    - ./scripts/check-deployed-commit "api.move.mil" "$CI_COMMIT_SHA" ${TLS_KEY} ${TLS_CERT} ${TLS_CA}
  after_script:
    - *announce_failure
  rules:
    - *check_main

deploy_app_prd:
  stage: deploy_prd
  resource_group: production_app
  tags:
    - $EKS_CLUSTER_RUNNER_TAG
  environment: prd
  image:
    name: $DOCKER_APP_IMAGE
    entrypoint: [""]
  needs:
    - build_push_app_prd
    - deploy_migrations_prd
    - compile_app_server
    - compile_app_client
  variables:
    OPEN_TELEMETRY_SIDECAR: "true"
    HEALTH_CHECK: "true"
  before_script:
    - *setup_tls_vars_prd
    - *setup_aws_vars_prd
    - *setup_release_prd
  script:
    - echo "Comparing against deployed commit"
    # - ./scripts/compare-deployed-commit "" "$CI_COMMIT_SHA" "$TLS_KEY" "$TLS_CERT" "$TLS_CA"
    - echo "Creating .go-version file if not already present"
    - |
      if [ -f ".go-version" ]; then
        echo ".go-version already exists, no need to re-create"
      else
        GO_VERSION=$(awk '/golang/ { print $2 }' .tool-versions)
        echo "Creating .go-version using version ${GO_VERSION}"
        echo $GO_VERSION > .go-version
      fi
    - echo "Getting Digest from AWS"
    - export ECR_DIGEST=$(aws ecr describe-images --repository-name app --image-ids imageTag=git-$CI_COMMIT_SHORT_SHA --query 'imageDetails[0].imageDigest' --output text)
    - echo "Getting otel collector digest from AWS"
    - export OTEL_ECR_DIGEST=$(aws ecr describe-images --repository-name otel-collector --image-ids imageTag=${OTEL_IMAGE_TAG} --query 'imageDetails[0].imageDigest' --output text)
    - export OTEL_COLLECTOR_IMAGE="${ECR_REPOSITORY_URI}/otel-collector@${OTEL_ECR_DIGEST}"
    - echo "Deploying app service"
    - ./scripts/ecs-deploy-service-container app "${ECR_REPOSITORY_URI}/app@${ECR_DIGEST}" "${APP_ENVIRONMENT}" "/bin/milmove serve"
    #TODO: fix domain make dynamic and pass in preferred
    - echo "Running Health Check"
    - bin/health-checker --schemes https --hosts my.move.mil,office.move.mil,admin.move.mil --tries 10 --backoff 3 --log-level info --timeout 5m
    - echo "Running TLS Check"
    - bin/tls-checker --schemes https --hosts my.move.mil,office.move.mil,admin.move.mil --log-level info --timeout 15m
    - echo "Checking deployed commits"
    - ./scripts/check-deployed-commit "my.move.mil,office.move.mil,admin.move.mil" "$CI_COMMIT_SHA"
  after_script:
    - *announce_failure
  rules:
    - *check_main